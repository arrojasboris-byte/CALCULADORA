<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CALCULADORA INFINITY AUDIO</title>
<style>
:root{
  --brand:#C71F2D;        /* rojo Infinity */
  --brand-dark:#a41724;
  --text:#1f2937;         /* gris oscuro */
  --muted:#6b7280;        /* gris medio  */
  --bg:#ffffff;
  --soft:#f6f7f9;
  --border:#e5e7eb;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--soft);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
.container{max-width:1024px;margin:0 auto;padding:20px}
.header{margin-bottom:14px}
.h1{font-weight:900;letter-spacing:.5px;color:var(--brand);font-size:44px;line-height:1.1;margin:0}
.sub{color:var(--muted);font-size:13px;margin-top:6px}

.paper{background:var(--bg);border-radius:16px;border:1px solid var(--border);box-shadow:0 4px 24px rgba(0,0,0,.04)}
.paper .hd{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.paper .bd{padding:18px}

.btn{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
.btn:hover{background:var(--brand-dark)}
.btn.out{background:#fff;color:var(--text);border:1px solid var(--border)}
.btn.small{padding:6px 10px;border-radius:8px;font-size:13px}
.row{display:grid;gap:12px}
.row.grid4{grid-template-columns:repeat(4,minmax(0,1fr))}
.row.grid2{grid-template-columns:repeat(2,minmax(0,1fr))}
.card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px;cursor:pointer}
.imgbox{height:140px;border-radius:12px;overflow:hidden;background:#f9fafb;display:flex;align-items:center;justify-content:center}
.imgbox img{max-width:100%;max-height:100%;object-fit:contain}
.label{font-size:12px;color:var(--muted);margin-top:6px;text-align:center}

.table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{font-size:14px}
th{color:var(--muted);font-weight:600;text-align:left}
tr.item{background:#fff}
tr.item td{padding:10px 12px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
tr.item td:first-child{border-left:1px solid var(--border);border-radius:12px 0 0 12px}
tr.item td:last-child{border-right:1px solid var(--border);border-radius:0 12px 12px 0}

.kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px}
.kpi .tt{font-size:12px;color:var(--muted)}
.kpi .val{font-size:22px;font-weight:800;margin-top:4px}
.kpi.red{background:var(--brand);color:#fff;border-color:transparent}
.kpi.red .tt{color:#fff;opacity:.9}

.upg{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
.upg .opt{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;cursor:pointer}
.upg .opt.active{border-color:var(--brand);box-shadow:0 0 0 2px rgba(199,16,46,.15)}
.opt .nm{font-weight:700}
.opt .inf{font-size:12px;color:var(--muted);margin-top:4px}

.tools{display:flex;gap:8px;flex-wrap:wrap}
.toolbar{display:flex;gap:8px;align-items:center}

input,select,textarea{border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}
input[disabled],textarea[disabled]{background:#f9fafb;color:#6b7280}
.search{display:flex;gap:8px}
.search input{flex:1}

.note{font-size:12px;color:var(--muted)}
.footer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

@media print{
  .no-print{display:none!important}
  body{background:#fff}
  .container{max-width:none}
}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="h1">CALCULADORA INFINITY<br/>AUDIO</h1>
      <div class="sub">36 MESES 0% TAE + 6 MESES 7,95% TAE</div>
    </div>

    <!-- Formatos -->
    <section class="paper">
      <div class="hd">
        <div class="ttl">Formatos de audífonos</div>
        <div class="toolbar no-print">
          <button id="btnEditar" class="btn small">Editar</button>
          <button id="btnGuardar" class="btn small" style="display:none">Guardar</button>
        </div>
      </div>
      <div class="bd">
        <div id="formatos" class="row grid4"></div>
      </div>
    </section>

    <!-- Características -->
    <section class="paper">
      <div class="hd">
        <div class="ttl">Características de gamas</div>
      </div>
      <div class="bd">
        <div class="search">
          <select id="selGama" class="editable" disabled></select>
          <input type="text" placeholder="Buscar característica…" disabled class="editable">
        </div>
        <div style="margin-top:10px">
          <textarea id="txtCar" rows="5" class="editable" disabled></textarea>
          <div class="note" style="margin-top:6px">Edición protegida con PIN 4321. Al guardar, se mantiene en este archivo (local).</div>
        </div>
      </div>
    </section>

    <!-- Gamas -->
    <section class="paper">
      <div class="hd"><div class="ttl">Gamas</div></div>
      <div class="bd">
        <table class="table">
          <thead>
            <tr><th>Gama</th><th>Precio</th><th>Características</th></tr>
          </thead>
          <tbody id="tbl-gamas"></tbody>
        </table>
      </div>
    </section>

    <!-- Financiación -->
    <section class="paper">
      <div class="hd"><div class="ttl">Financiación Infinity</div></div>
      <div class="bd">
        <div class="kpis">
          <div class="kpi red"><div class="tt">Importe base</div><div id="impBase" class="val">—</div></div>
          <div class="kpi"><div class="tt">Cuota 36m</div><div id="c36Base" class="val">—</div></div>
          <div class="kpi"><div class="tt">Restante (6m)</div><div id="restBase" class="val">—</div></div>
          <div class="kpi"><div class="tt">Cuota 6m (7,95% TAE)</div><div id="c6Base" class="val">—</div></div>
        </div>
        <div style="height:10px"></div>
        <div class="kpis">
          <div class="kpi red"><div class="tt">Importe con upgrade</div><div id="impUpg" class="val">—</div></div>
          <div class="kpi"><div class="tt">Cuota 36m</div><div id="c36Upg" class="val">—</div></div>
          <div class="kpi"><div class="tt">Restante (6m)</div><div id="restUpg" class="val">—</div></div>
          <div class="kpi"><div class="tt">Cuota 6m (7,95% TAE)</div><div id="c6Upg" class="val">—</div></div>
        </div>
        <div class="footer-actions no-print">
          <button class="btn out" onclick="window.print()">Guardar PDF</button>
        </div>
      </div>
    </section>

    <!-- Upgrade -->
    <section class="paper">
      <div class="hd"><div class="ttl">UPGRADE</div></div>
      <div class="bd">
        <div id="upgrades" class="upg"></div>
      </div>
    </section>

  </div>

<script>
/* ========= CONFIG ========= */
const STORAGE_KEY = 'calc_infy_local_v1';
const PIN = '4321';

const imgSvg = (label)=>`data:image/svg+xml;utf8,` + encodeURIComponent(
  \`<svg xmlns='http://www.w3.org/2000/svg' width='600' height='450'>
     <rect x='10' y='10' width='580' height='430' rx='16' ry='16' fill='%23f9fafb' stroke='%23e5e7eb' stroke-width='3'/>
     <text x='300' y='235' font-family='Arial, sans-serif' font-size='28' fill='%23999' text-anchor='middle'>${label}</text>
   </svg>\`
);

const FORMATOS = [
  { id:'ric',  nombre:'RIC / RIC Premium', img: imgSvg('RIC / RIC Premium') },
  { id:'bte',  nombre:'BTE',                img: imgSvg('BTE') },
  { id:'cic',  nombre:'Intracanal estándar',img: imgSvg('Intracanal estándar') },
  { id:'ite',  nombre:'Intracanal a medida',img: imgSvg('Intracanal a medida') },
];

const GAMAS = [
  { id:'diamante_plus', nombre:'Diamante Plus', precio:3995, recomendado:'Diamante Plus (+2004)', upgImporte:2004 },
  { id:'diamante',      nombre:'Diamante',      precio:3895, recomendado:'Diamante (+1904)',      upgImporte:1904 },
  { id:'platino_plus',  nombre:'Platino Plus',  precio:3395, recomendado:'Platino Plus (+1404)',  upgImporte:1404 },
  { id:'platino',       nombre:'Platino',       precio:3295, recomendado:'Platino (+1294)',       upgImporte:1294 },
  { id:'oro',           nombre:'Oro',           precio:1991, recomendado:'—',                     upgImporte:0    },
];

/* ========= STATE ========= */
let state = {
  selectedFormato: 'ric',
  selectedGamaId: 'diamante_plus', // por defecto
  upgradeActivo: true,
  pinOk: false,
  caracteristicas: {
    diamante_plus: '• Prestaciones máximas\\n• 16 canales\\n• Reducción de ruido avanzada\\n• Bluetooth LE',
    diamante:      '• Gran rendimiento\\n• 14 canales\\n• Control inteligencia ambiental',
    platino_plus:  '• 12 canales\\n• IP67\\n• Carga rápida',
    platino:       '• 10 canales\\n• Control básico de ruido',
    oro:           '• 6 canales\\n• Esencial',
  }
};

// Cargar guardado local si existe
try{
  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  if (saved && Object.keys(saved).length) state = { ...state, ...saved };
}catch(e){}

/* ========= Helpers ========= */
const $ = (s,ctx=document)=>ctx.querySelector(s);
const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));
const fmt = n => n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+' €';
const mensualidad=(p,m,t)=>{ const r=t/12; if(!r) return p/m; const pow=Math.pow(1+r,m); return p*(r*pow)/(pow-1); };
const persist = ()=> localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

/* ========= UI ========= */
function renderFormatos(){
  const wrap = $('#formatos'); wrap.innerHTML='';
  FORMATOS.forEach(f=>{
    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = \`
      <div class="imgbox"><img src="\${f.img}" alt=""></div>
      <div class="label">\${f.nombre}</div>\`;
    card.addEventListener('click', ()=>{ state.selectedFormato=f.id; persist(); highlightFormatos(); });
    wrap.appendChild(card);
  });
  highlightFormatos();
}
function highlightFormatos(){
  $$('#formatos .card').forEach((el,i)=>{
    const f = FORMATOS[i];
    el.style.outline = (state.selectedFormato === f.id) ? '2px solid var(--brand)' : 'none';
  });
}

function renderGamas(){
  const body = $('#tbl-gamas'); body.innerHTML='';
  GAMAS.forEach(g=>{
    const tr = document.createElement('tr');
    tr.className='item';
    tr.innerHTML = \`
      <td style="width:220px">
        <label style="display:flex;gap:8px;align-items:center">
          <input type="radio" name="gama" value="\${g.id}" \${state.selectedGamaId===g.id?'checked':''}>
          <strong>\${g.nombre}</strong>
        </label>
      </td>
      <td style="width:120px">\${fmt(g.precio)}</td>
      <td>
        <div class="note">\${(state.caracteristicas[g.id]||'').split('\\n').slice(0,1)}</div>
        <button class="btn small out no-print" data-cf="\${g.id}">Ver características</button>
      </td>\`;
    tr.querySelector('input').addEventListener('change', ()=>{
      state.selectedGamaId = g.id;
      state.upgradeActivo = true;            // recomendado por defecto
      persist();
      renderUpgrade();
      calcular();
    });
    tr.querySelector('[data-cf]').addEventListener('click', ()=> verCaracteristicas(g.id));
    body.appendChild(tr);
  });
}
function verCaracteristicas(gid){
  const txt = state.caracteristicas[gid] || 'Sin características.';
  alert(\`\${GAMAS.find(x=>x.id===gid).nombre}\\n\\n\${txt}\`);
}

function renderUpgrade(){
  const container = $('#upgrades'); container.innerHTML='';
  const idx = GAMAS.findIndex(g=>g.id===state.selectedGamaId);
  const permitidos = GAMAS.slice(idx); // misma o inferior
  permitidos.forEach((g,i)=>{
    const active = (state.upgradeActivo && i===0);
    const opt = document.createElement('div');
    opt.className = 'opt'+(active?' active':'');
    opt.innerHTML = \`
      <div class="nm">\${g.nombre} \${g.upgImporte?`(+\${fmt(g.upgImporte)})`:''}</div>
      <div class="inf">\${i===0?'Recomendado':''}</div>\`;
    opt.addEventListener('click', ()=>{
      if (i===0){
        state.upgradeActivo = !state.upgradeActivo; // activar/desactivar recomendado
      }else{
        // Si pulsa una inferior: cambia la base a esa gama y activa su recomendado
        state.selectedGamaId = g.id;
        state.upgradeActivo = true;
      }
      persist();
      renderGamas();
      renderUpgrade();
      calcular();
    });
    container.appendChild(opt);
  });
}

function calcular(){
  const g = GAMAS.find(x=>x.id===state.selectedGamaId);
  const importeBase = g.precio;
  const cuotaBase36 = importeBase/42;
  const restanteBase = importeBase - cuotaBase36*36;
  const cuotaBase6 = mensualidad(restanteBase,6,0.0795);

  $('#impBase').textContent = fmt(importeBase);
  $('#c36Base').textContent = fmt(cuotaBase36);
  $('#restBase').textContent = fmt(restanteBase);
  $('#c6Base').textContent = fmt(cuotaBase6);

  const totalUpg = state.upgradeActivo ? (importeBase + (g.upgImporte||0)) : importeBase;
  const cuotaUpg36 = totalUpg/42;
  const restanteUpg = totalUpg - cuotaUpg36*36;
  const cuotaUpg6 = mensualidad(restanteUpg,6,0.0795);

  $('#impUpg').textContent = fmt(totalUpg);
  $('#c36Upg').textContent = fmt(cuotaUpg36);
  $('#restUpg').textContent = fmt(restanteUpg);
  $('#c6Upg').textContent = fmt(cuotaUpg6);
}

/* ========= Edición (PIN) ========= */
function pedirPin(){
  const p = prompt('Introduce el PIN:');
  if (p===PIN){
    state.pinOk = true;
    persist();
    toggleEdicion(true);
  } else {
    alert('PIN incorrecto');
  }
}
function toggleEdicion(){
  const ed = !!state.pinOk;
  $$('.editable').forEach(el=> el.disabled = !ed);
  $('#btnGuardar').style.display = ed ? 'inline-flex' : 'none';
}
function guardar(){
  persist();
  alert('✅ Cambios guardados en este archivo.');
}

// Editor de características
function bindCaracteristicas(){
  const sel = $('#selGama');
  sel.innerHTML = GAMAS.map(g=>`<option value="${g.id}">${g.nombre}</option>`).join('');
  sel.value = state.selectedGamaId;

  $('#txtCar').value = state.caracteristicas[state.selectedGamaId] || '';
  sel.addEventListener('change', ()=>{
    $('#txtCar').value = state.caracteristicas[sel.value] || '';
  });
  $('#txtCar').addEventListener('input', (e)=>{
    state.caracteristicas[sel.value] = e.target.value;
  });
}

/* ========= Init ========= */
function init(){
  renderFormatos();
  renderGamas();
  renderUpgrade();
  bindCaracteristicas();
  toggleEdicion(false);
  calcular();

  // eventos
  $('#btnEditar').addEventListener('click', pedirPin);
  $('#btnGuardar').addEventListener('click', guardar);
  $('#selGama').addEventListener('change', e=>{
    state.selectedGamaId = e.target.value;
    persist();
    renderGamas();
    renderUpgrade();
    calcular();
  });
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
