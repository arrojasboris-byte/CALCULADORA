<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CALCULADORA INFINITY AUDIO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { background:#f6f7f9; }
    .card { box-shadow: 0 6px 24px rgba(0,0,0,.06); }
    /* Imágenes nítidas, centradas, sin adornos */
    .imgWrap { position:relative; width:100%; aspect-ratio: 1 / 1; background:#ffffff; border-radius: 0.75rem; display:flex; align-items:center; justify-content:center; overflow:hidden; border:1px solid #e5e7eb; }
    .imgWrap img { width:100%; height:100%; object-fit:contain; image-rendering:auto; }
    .tiny { font-size: 10px; line-height: 1; text-align:center; color:#6b7280; }
    @media print { .no-print { display:none !important; } html, body { background:white; } }
  </style>
</head>
<body class="min-h-screen text-gray-900">
  <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
    <!-- Header -->
    <header class="flex items-center justify-between gap-4">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-red-700">CALCULADORA INFINITY AUDIO</h1>
      <div class="no-print flex items-center gap-2">
        <button id="btnShare" class="hidden sm:inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium bg-red-600 text-white hover:bg-red-700">Compartir enlace</button>
        <button id="btnPin" class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium bg-gray-900 text-white hover:bg-gray-800">Editar</button>
        <button id="btnLock" class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium bg-gray-200 text-gray-900 hover:bg-gray-300">Bloqueado</button>
      </div>
    </header>

    <!-- Formatos de audífonos -->
    <section class="paper bg-white rounded-2xl p-5 card">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Formatos de audífonos</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="imgGrid">
        <!-- 4 boxes injected by JS -->
      </div>
    </section>

    <!-- Gama y características -->
    <section class="paper bg-white rounded-2xl p-5 card space-y-4">
      <h2 class="text-xl font-semibold text-gray-800">Selecciona gama</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="col-span-1">
          <label for="tier" class="block text-sm font-medium text-gray-700 mb-1">Gama</label>
          <select id="tier" class="w-full rounded-xl border border-gray-300 p-2 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500"></select>
        </div>
        <div class="col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">Características de la gama</label>
          <textarea id="feat" rows="6" class="w-full rounded-xl border border-gray-300 p-3 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Características..." disabled></textarea>
          <p id="featHint" class="text-xs text-gray-500 mt-1">Para editar, pulsa “Editar”.</p>
        </div>
      </div>
    </section>

    <!-- Financiación -->
    <section class="paper bg-white rounded-2xl p-5 card space-y-4">
      <div class="flex items-center gap-3">
        <h2 class="text-xl font-semibold text-gray-800">Financiación Infinity</h2>
        <span class="text-xs text-gray-500">(42 meses: 36m 0% + 6m al 7,95% TAE)</span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-stretch">
        <div class="rounded-2xl border border-red-600 text-red-700 p-4">
          <div class="text-xs opacity-90">Importe total</div>
          <div id="imp" class="text-2xl font-extrabold"></div>
        </div>
        <div class="rounded-2xl bg-red-600 text-white p-4">
          <div class="text-xs opacity-90">Cuota 36 meses (0%)</div>
          <div id="c36" class="text-2xl font-extrabold"></div>
        </div>
        <div class="rounded-2xl border border-gray-200 p-4">
          <div class="text-xs opacity-90">Principal restante (6 meses)</div>
          <div id="rest6" class="text-xl font-semibold"></div>
        </div>
        <div class="rounded-2xl border border-gray-200 p-4">
          <div class="text-xs opacity-90">Cuota 6 meses (7,95% TAE)</div>
          <div id="c6" class="text-xl font-semibold"></div>
        </div>
      </div>
    </section>

    <!-- RECOMENDADO: suma (gama + 2ª pareja con precio especial por gama) -->
    <section class="paper bg-white rounded-2xl p-5 card space-y-3">
      <h2 class="text-xl font-extrabold text-red-700">RECOMENDADO — 2ª pareja MISMA GAMA</h2>
      <p class="text-xs text-gray-500">Se suma el precio de la gama elegida + el precio especial de 2ª pareja para esa misma gama.</p>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-stretch">
        <div class="rounded-2xl border border-red-600 text-red-700 p-4">
          <div class="text-xs opacity-90">Importe total (gama + 2ª pareja)</div>
          <div id="imp2" class="text-2xl font-extrabold"></div>
        </div>
        <div class="rounded-2xl bg-red-600 text-white p-4">
          <div class="text-xs opacity-90">Cuota 36 meses (0%)</div>
          <div id="c36_2" class="text-2xl font-extrabold"></div>
        </div>
        <div class="rounded-2xl border border-gray-200 p-4">
          <div class="text-xs opacity-90">Principal restante (6 meses)</div>
          <div id="rest6_2" class="text-xl font-semibold"></div>
        </div>
        <div class="rounded-2xl border border-gray-200 p-4">
          <div class="text-xs opacity-90">Cuota 6 meses (7,95% TAE)</div>
          <div id="c6_2" class="text-xl font-semibold"></div>
        </div>
      </div>
    </section>

    <footer class="py-8 text-center text-xs text-gray-500">
      © Infinity — Cálculos orientativos (TAE 7,95% para los últimos 6 meses).
    </footer>
  </div>

  <!-- PIN modal (PIN no visible) -->
  <div id="pinModal" class="no-print hidden fixed inset-0 z-50 bg-black/40 items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-sm w-full p-5 space-y-4" role="dialog" aria-label="Introducir PIN">
      <h3 class="text-lg font-bold">Editar contenido</h3>
      <p class="text-sm text-gray-600">Introduce el PIN para desbloquear la edición de <strong>imágenes</strong> y <strong>características</strong>.</p>
      <input id="pinInput" type="password" class="w-full rounded-xl border border-gray-300 p-2 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="PIN">
      <div class="flex justify-end gap-2">
        <button id="pinCancel" class="rounded-lg px-3 py-1.5 text-sm bg-gray-200">Cancelar</button>
        <button id="pinOk" class="rounded-lg px-3 py-1.5 text-sm bg-red-600 text-white">Desbloquear</button>
      </div>
    </div>
  </div>

<script>
// ---------- Datos ----------
const PIN_CODE = "4321"; // nunca se muestra en UI
const TIER_ORDER = ["diamante_plus","diamante","platino_plus","platino","oro"]; // mayor a menor

// Precio normal de la 1ª pareja por gama
const TIERS = {
  oro:            {label:"Oro",            amount:1991,        feat:"• Prestaciones esenciales\\n• Conectividad básica"},
  platino:        {label:"Platino",        amount:3285,        feat:"• Reducción de ruido avanzada\\n• Más autonomía"},
  platino_plus:   {label:"Platino Plus",   amount:3395,        feat:"• Rendimiento premium\\n• Mejor direccionalidad"},
  diamante:       {label:"Diamante",       amount:3895,        feat:"• Máxima claridad\\n• Filtros inteligentes"},
  diamante_plus:  {label:"Diamante Plus",  amount:3995,        feat:"• Top de gama\\n• Procesamiento superior"},
};

// Precio especial de 2ª pareja (misma gama)
const SECOND_PAIR = {
  diamante_plus: 2004,
  diamante: 1904,
  platino_plus: 1404,
  platino: 1304,
  // Si una gama no está especificada (p. ej. Oro), por defecto usa el mismo precio de la gama
};

const IMG_CAPTIONS = ["RIC / RIC PLUS","BTE POTENTE","INTRACANAL A MEDIDA","INTRACANAL ESTÁNDAR"];

// ---------- Estado ----------
let state = {
  tier: "diamante_plus",
  features: {
    oro: TIERS.oro.feat,
    platino: TIERS.platino.feat,
    platino_plus: TIERS.platino_plus.feat,
    diamante: TIERS.diamante.feat,
    diamante_plus: TIERS.diamante_plus.feat,
  },
  images: [null,null,null,null],
  locked: true,
};

// cargar de localStorage
try{
  const raw = localStorage.getItem("infinity_calc_v4");
  if(raw){ const s = JSON.parse(raw); Object.assign(state, s); }
}catch{}

// ---------- Utilidades ----------
async function compressImageToDataURL(file, maxDim=1200, quality=0.8){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = ()=>{
      let {width:w,height:h} = img;
      const scale = Math.min(1, maxDim / Math.max(w,h));
      const cw = Math.round(w*scale), ch = Math.round(h*scale);
      const canvas = document.createElement('canvas');
      canvas.width = cw; canvas.height = ch;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, cw, ch);
      try{
        const out = canvas.toDataURL('image/jpeg', quality);
        URL.revokeObjectURL(url);
        resolve(out);
      }catch(e){ reject(e); }
    };
    img.onerror = reject;
    img.src = url;
  });
}
const fmt = n => (n ?? 0).toLocaleString("es-ES",{minimumFractionDigits:2, maximumFractionDigits:2});
function monthlyPayment(principal, months, annualRate) {
  const r = annualRate/12;
  if (r === 0) return principal / months;
  const pow = Math.pow(1+r, months);
  return principal * (r*pow)/(pow-1);
}
function save(){
  try{
    localStorage.setItem("infinity_calc_v4", JSON.stringify(state));
    return true;
  }catch(e){
    console.warn("No se pudo guardar en localStorage:", e);
    const msg = document.getElementById("featHint") || document.getElementById("msg") || document.body;
    if(msg && msg.insertAdjacentHTML){
      msg.insertAdjacentHTML("beforeend", '<div class="text-xs text-red-600 mt-1">⚠️ No se pudo guardar (memoria del navegador llena). Reduce el tamaño o número de imágenes.</div>');
    }
    return false;
  }
}

// ---------- UI refs ----------
const tierSel = document.getElementById("tier");
const featTA  = document.getElementById("feat");
const featHint= document.getElementById("featHint");
const imgGrid = document.getElementById("imgGrid");
const btnPin  = document.getElementById("btnPin");
const btnLock = document.getElementById("btnLock");
const btnShare= document.getElementById("btnShare");
const pinModal= document.getElementById("pinModal");
const pinInput= document.getElementById("pinInput");
document.getElementById("pinCancel").onclick=()=>pinModal.classList.add("hidden");
document.getElementById("pinOk").onclick=()=>{
  if(pinInput.value===PIN_CODE){ state.locked=false; pinModal.classList.add("hidden"); refreshLock(); enableEditing(true); save(); }
  else alert("PIN incorrecto");
};

btnPin.onclick=()=>{ pinInput.value=""; pinModal.classList.remove("hidden"); pinInput.focus(); };
btnLock.onclick=()=>{ state.locked=true; refreshLock(); enableEditing(false); save(); };

// compartir enlace (serializa estado)
btnShare.onclick=()=>{
  const s = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
  const url = location.origin + location.pathname + "#s=" + s;
  navigator.clipboard?.writeText(url);
  alert("Enlace copiado al portapapeles.");
};

function enableEditing(on){
  featTA.disabled = !on;
  refreshImages();
  featHint.textContent = on ? "Editando. Los cambios se guardan automáticamente." : "Para editar, pulsa “Editar”.";
}
function refreshLock(){
  btnLock.textContent = state.locked ? "Bloqueado" : "Bloquear";
  btnLock.className = state.locked
    ? "inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium bg-gray-200 text-gray-900 hover:bg-gray-300"
    : "inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-medium bg-red-50 text-red-700 border border-red-200 hover:bg-red-100";
}

// ---------- Construir grillas ----------
function refreshImages(){
  imgGrid.innerHTML = "";
  IMG_CAPTIONS.forEach((cap, i)=>{
    const wrap = document.createElement("div");
    wrap.className="space-y-1";
    const box = document.createElement("div");
    box.className="imgWrap";
    if(state.images[i]){
      const img = document.createElement("img");
      img.src = state.images[i];
      box.appendChild(img);
    }else{
      const span = document.createElement("span");
      span.className="text-gray-300 text-sm";
      span.textContent=" ";
      box.appendChild(span);
    }

    if(!state.locked){
      const file = document.createElement("input");
      file.type="file"; file.accept="image/*";
      file.className="no-print absolute bottom-2 left-2 text-[11px]";
      file.onchange = (e)=>{
        const f = e.target.files?.[0];
        if(!f) return;
        compressImageToDataURL(f, 1200, 0.8).then(data=>{ state.images[i] = String(data); save(); refreshImages(); }).catch(()=>{ /* fallback */ const r=new FileReader(); r.onload=ev=>{ state.images[i]=String(ev.target.result); save(); refreshImages(); }; r.readAsDataURL(f); });
      };
      const del = document.createElement("button");
      del.textContent="✕"; del.title="Quitar";
      del.className="no-print absolute top-2 right-2 bg-white/80 rounded-full w-6 h-6 text-gray-700";
      del.onclick=()=>{ state.images[i]=null; save(); refreshImages(); };
      box.appendChild(file);
      box.appendChild(del);
    }

    const label = document.createElement("div");
    label.className="tiny";
    label.textContent = cap;

    wrap.appendChild(box);
    wrap.appendChild(label);
    imgGrid.appendChild(wrap);
  });
}

function buildTierSelect(){
  tierSel.innerHTML="";
  TIER_ORDER.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = `${TIERS[k].label} — ${fmt(TIERS[k].amount)} €`;
    tierSel.appendChild(opt);
  });
  tierSel.value = state.tier;
}

function calcBlocks(total){
  const cuota36 = total/42;          // meses 0% prorrateando capital total
  const restante = total - 36*cuota36;
  const cuota6 = monthlyPayment(restante, 6, 0.0795);
  return { total, cuota36, restante, cuota6 };
}

function refreshCalc(){
  // Bloque principal (importe de la gama)
  const base = TIERS[state.tier].amount;
  const a = calcBlocks(base);
  document.getElementById("imp").textContent  = fmt(a.total) + " €";
  document.getElementById("c36").textContent  = fmt(a.cuota36) + " €";
  document.getElementById("rest6").textContent= fmt(a.restante) + " €";
  document.getElementById("c6").textContent   = fmt(a.cuota6) + " €";

  // RECOMENDADO = base + precio especial de 2ª pareja (por gama).
  const second = (SECOND_PAIR[state.tier] ?? base);
  const totalRec = base + second;
  const b = calcBlocks(totalRec);
  document.getElementById("imp2").textContent  = fmt(b.total) + " €";
  document.getElementById("c36_2").textContent = fmt(b.cuota36) + " €";
  document.getElementById("rest6_2").textContent = fmt(b.restante) + " €";
  document.getElementById("c6_2").textContent  = fmt(b.cuota6) + " €";
}

function refreshFeaturesUI(){
  featTA.value = (state.features[state.tier] || "");
}

function refreshAll(){
  buildTierSelect();
  refreshLock();
  enableEditing(!state.locked);
  refreshFeaturesUI();
  refreshCalc();
}

// eventos
tierSel.onchange = (e)=>{ state.tier = e.target.value; save(); refreshFeaturesUI(); refreshCalc(); };
featTA.oninput = (e)=>{ state.features[state.tier] = e.target.value; save(); };

// cargar de hash (#s=...) si existe
(function(){
  const m = (location.hash||"").match(/#s=([^&]+)/);
  if(m && m[1]){
    try{
      const decoded = JSON.parse(decodeURIComponent(escape(atob(m[1]))));
      if(decoded && decoded.tier){ state = Object.assign(state, decoded); save(); }
    }catch{}
  }
})();

// init
refreshImages();
refreshAll();
</script>
</body>
</html>
