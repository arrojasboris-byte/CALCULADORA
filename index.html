<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CALCULADORA INFINITY AUDIO</title>
<style>
  :root{
    --rojo:#d62b2b;
    --rojo-osc:#c02020;
    --gris:#f4f5f7;
    --borde:#e6e6e6;
    --texto:#222;
    --muted:#6b7280;
    --card:#ffffff;
  }
  html,body{margin:0;padding:0;background:#fff;color:var(--texto);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;}
  .wrap{max-width:1020px;margin:24px auto;padding:0 16px;}
  h1{margin:0 0 8px 0;font-size:40px;letter-spacing:.5px;}
  .sub{color:#8f8f8f;font-size:12px;margin:0 0 16px 0}
  /* card / secciones */
  .card{background:var(--card);border:1px solid var(--borde);border-radius:10px;box-shadow:0 1px 0 rgba(0,0,0,.02);margin:12px 0;}
  .bar{background:var(--rojo);color:#fff;font-weight:700;font-size:14px;padding:10px 14px;border-top-left-radius:10px;border-top-right-radius:10px;display:flex;align-items:center;justify-content:space-between}
  .bar small{opacity:.9;font-weight:600}
  .body{padding:14px}
  /* formatos */
  .formatos{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .format{border:1px solid var(--borde);border-radius:10px;background:var(--gris);position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;height:150px;cursor:pointer}
  .format.active{outline:2px solid var(--rojo)}
  .format input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;display:none}
  .format img{max-height:120px;max-width:90%;object-fit:contain;filter:drop-shadow(0 1px 2px rgba(0,0,0,.1))}
  .format .ph{color:#9aa1ab;font-weight:700}
  .fmt-caption{margin-top:6px;text-align:center;font-size:12px;color:#666}
  .fmt-box{display:flex;flex-direction:column;gap:6px}
  /* gamas */
  .grid-2{display:grid;grid-template-columns:260px 1fr;gap:12px}
  .gamas{display:flex;flex-direction:column;gap:8px}
  .gbtn{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--borde);background:#fff;border-radius:8px;padding:10px 12px;cursor:pointer}
  .gbtn.active{border-color:var(--rojo);box-shadow:0 0 0 2px rgba(214,43,43,.1)}
  .gbtn .precio{color:#111;font-weight:700;font-size:12px}
  .gbtn .nombre{font-weight:700}
  textarea{width:100%;min-height:140px;border:1px solid var(--borde);border-radius:8px;padding:10px;resize:vertical;font-family:inherit}
  .help{font-size:12px;color:#8590a2;margin-top:6px}
  /* financiación */
  .fin-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .box{border:1px solid var(--borde);border-radius:10px;background:#fff;padding:12px}
  .ttl{font-size:12px;color:#6b7280;font-weight:600;margin-bottom:2px}
  .num{font-size:26px;font-weight:800;color:#111}
  .num.red{color:var(--rojo)}
  .subtxt{font-size:12px;color:#6b7280}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{background:#fff;border:1px solid var(--borde);padding:9px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .btn:hover{border-color:#bbb}
  .btn.red{background:var(--rojo);border-color:var(--rojo);color:#fff}
  .btn.red:hover{background:var(--rojo-osc)}
  /* upgrade */
  .upg-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .upg{border:1px solid var(--borde);border-radius:10px;padding:12px;background:#fff;font-weight:800;text-align:center;cursor:pointer}
  .upg.disabled{opacity:.45;cursor:not-allowed;filter:grayscale(.3)}
  .upg.active{background:var(--rojo);border-color:var(--rojo);color:#fff}
  /* compromisos */
  details summary{cursor:pointer;font-weight:800}
  .muted{color:#6b7280}
  /* edición */
  .right{display:flex;gap:8px;align-items:center}
  .pin{width:82px;border:1px solid var(--borde);border-radius:6px;padding:6px 8px}
  .hidden{display:none !important}
  /* print */
  @media print{
    .no-print{display:none !important}
    .wrap{max-width:794px}
    @page{size:A4;margin:12mm}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>CALCULADORA INFINITY AUDIO</h1>
  <p class="sub">36 MESES 0%TAE + 6 MESES 7,95% TAE</p>

  <!-- FORMATOS -->
  <div class="card">
    <div class="bar">
      <span>Formatos de audífonos</span>
      <div class="right no-print">
        <input id="pin1" class="pin" type="password" placeholder="PIN" />
        <button id="btnEditar" class="btn red">Editar</button>
        <button id="btnGuardar" class="btn hidden">Guardar</button>
      </div>
    </div>
    <div class="body formatos" id="formatos">
      <!-- generado por JS -->
    </div>
  </div>

  <!-- CARACTERÍSTICAS Y GAMAS -->
  <div class="card">
    <div class="bar"><span>Características y gamas</span></div>
    <div class="body grid-2">
      <div class="gamas" id="listaGamas"></div>
      <div>
        <div class="ttl">Características — <span id="lblGamaSel">–</span></div>
        <textarea id="txtCar"></textarea>
        <div class="help">Para editar las características introduce el PIN y pulsa “Editar”.</div>
      </div>
    </div>
  </div>

  <!-- FINANCIACIÓN -->
  <div class="card">
    <div class="bar"><span>Financiación Infinity + tchin tchin</span></div>
    <div class="body">
      <div class="fin-grid" id="finBase">
        <div class="box">
          <div class="ttl">Importe total</div>
          <div class="num" id="impBase">—</div>
        </div>
        <div class="box">
          <div class="ttl">Cuota 36m (0%)</div>
          <div class="num red" id="c36Base">—</div>
          <div class="subtxt" id="c36det">— / 42</div>
        </div>
        <div class="box">
          <div class="ttl">RESTANTE 6M–AHORRO SI RENUEVAS</div>
          <div class="num" id="restBase">—</div>
        </div>
        <div class="box">
          <div class="ttl">Cuota 6m (7,95% TAE)</div>
          <div class="num" id="c6Base">—</div>
        </div>
      </div>

      <div class="fin-grid" style="margin-top:10px" id="finUpg">
        <div class="box">
          <div class="ttl">Importe con 2ª pareja</div>
          <div class="num" id="impUpg">—</div>
        </div>
        <div class="box">
          <div class="ttl">Cuota 36m (0%)</div>
          <div class="num red" id="c36Upg">—</div>
          <div class="subtxt" id="c36detU">— / 42</div>
        </div>
        <div class="box">
          <div class="ttl">RESTANTE 6M–AHORRO SI RENUEVAS</div>
          <div class="num" id="restUpg">—</div>
        </div>
        <div class="box">
          <div class="ttl">Cuota 6m (7,95% TAE)</div>
          <div class="num" id="c6Upg">—</div>
        </div>
      </div>

      <div class="row no-print">
        <button id="btnPDF" class="btn">Guardar PDF</button>
        <button id="btnExport" class="btn">Descargar HTML con datos (solo lectura)</button>
      </div>
    </div>
  </div>

  <!-- 2ª PAREJA -->
  <div class="card">
    <div class="bar"><span>2º PAREJA RECOMENDADA</span></div>
    <div class="body">
      <div class="upg-grid" id="upgrades"></div>
      <div class="help">Se muestra en rojo la de la misma gama; las superiores se deshabilitan.</div>
    </div>
  </div>

  <!-- COMPROMISOS -->
  <div class="card">
    <div class="bar"><span>COMPROMISOS</span></div>
    <div class="body">
      <details id="detComp" open>
        <summary>Mostrar / ocultar</summary>
        <textarea id="txtComp" style="min-height:120px"></textarea>
        <div class="help">Editable con PIN (usa el botón “Editar”).</div>
      </details>
    </div>
  </div>

</div>

<script>
/* ====== Datos base ====== */
const PIN = "4321";
const factorTAE = 1.0235; // ajusta 47,40 -> 48,51
const gamas = [
  { id:"diamantePlus", nombre:"Diamante Plus", precio:3995, upg:+2004,
    car:`Amplio ancho de bandas-canales de programación.
Bluetooth universal
Streaming de Audio directo
Tcoil
Recargable
Multifoco, detecta hasta 4 hablantes para mayor entendimiento en ruido.
Autonomía de la carga de la batería hasta 5h
Ajuste en remoto
Programa Tinnitus`
  },
  { id:"diamante", nombre:"Diamante", precio:3895, upg:+1904,
    car:`Gran rendimiento
14 canales
Control inteligencia ambiental`
  },
  { id:"platinoPlus", nombre:"Platino Plus", precio:3395, upg:+1404,
    car:`Rendimiento alto en ruidos moderados
12 canales
Opciones de conectividad`
  },
  { id:"platino", nombre:"Platino", precio:3295, upg:+1304,
    car:`Buen desempeño general
10 canales
Ajustes esenciales`
  },
  { id:"oro", nombre:"Oro", precio:1991, upg:0,
    car:`Funcional para todas las pérdidas auditivas
Confort en ambientes silenciosos, sin ruidos.
Pilas
Programa de Tinnitus
Otros programas de programación específicos y personalizados.
Ancho de bandas de programación más limitado`
  }
];

const formatos = [
  {id:"fmt1", titulo:"RIC / RIC Premium"},
  {id:"fmt2", titulo:"BTE"},
  {id:"fmt3", titulo:"Intracanal estándar"},
  {id:"fmt4", titulo:"Intracanal a medida"}
];

/* ====== Estado ====== */
let state = {
  gamaSel: "diamantePlus",
  car: {},         // por gama
  imgs: {},        // base64 por formato
  comp: "",
  edit: false,
  upgSel: "diamantePlus" // por defecto misma gama (se mostrará activa en rojo)
};

// Cargar de localStorage si existe
const saved = localStorage.getItem("calc_infinity_audio_v1");
if(saved){
  try{ Object.assign(state, JSON.parse(saved)); }catch(e){}
}
// inicializa car por defecto
for(const g of gamas){
  if(!state.car[g.id]) state.car[g.id] = g.car;
}

/* ====== Utilidades ====== */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const fmtMoney = n => n.toLocaleString("es-ES",{style:"currency",currency:"EUR"});
const saveLS = ()=>localStorage.setItem("calc_infinity_audio_v1", JSON.stringify(state));

/* ====== Render formatos ====== */
function renderFormatos(){
  const box = $("#formatos");
  box.innerHTML = "";
  formatos.forEach(f=>{
    const wrap = document.createElement("div");
    wrap.className="fmt-box";
    const el = document.createElement("div");
    el.className = "format";
    el.dataset.id = f.id;
    if(state.edit) el.classList.add("active");

    const img = document.createElement("img");
    if(state.imgs[f.id]) img.src = state.imgs[f.id];
    else{
      const ph = document.createElement("div");
      ph.className="ph"; ph.textContent=f.titulo;
      el.appendChild(ph);
    }
    if(state.imgs[f.id]) el.appendChild(img);

    const inp = document.createElement("input");
    inp.type="file"; inp.accept="image/*";
    if(state.edit){ inp.style.display="block"; }
    inp.addEventListener("change", ev=>{
      const file = ev.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        state.imgs[f.id] = e.target.result;
        saveLS(); renderFormatos();
      };
      reader.readAsDataURL(file);
    });
    el.appendChild(inp);

    const cap = document.createElement("div");
    cap.className="fmt-caption";
    cap.textContent = f.titulo;

    wrap.appendChild(el);
    wrap.appendChild(cap);
    box.appendChild(wrap);
  });
}

/* ====== Render gamas + características ====== */
function renderGamas(){
  const lst = $("#listaGamas");
  lst.innerHTML = "";
  gamas.forEach(g=>{
    const b = document.createElement("button");
    b.className="gbtn";
    if(g.id===state.gamaSel) b.classList.add("active");
    b.innerHTML = `<span class="nombre">${g.nombre}</span><span class="precio">${fmtMoney(g.precio)}</span>`;
    b.onclick = ()=>{
      state.gamaSel = g.id;
      // por defecto, 2ª pareja de la misma gama
      state.upgSel = g.id;
      saveLS(); renderAll();
    };
    lst.appendChild(b);
  });
  $("#lblGamaSel").textContent = gamas.find(x=>x.id===state.gamaSel).nombre;
  const t = $("#txtCar");
  t.value = state.car[state.gamaSel] || "";
  t.disabled = !state.edit;
}

/* ====== Render financiación ====== */
function calcCuotas(importe){
  const c36 = importe/42;
  const resto6 = c36*6;
  const c6 = c36*factorTAE;
  return { c36, resto6, c6 };
}
function renderFin(){
  const g = gamas.find(x=>x.id===state.gamaSel);
  const imp = g.precio;
  const c = calcCuotas(imp);
  $("#impBase").textContent = fmtMoney(imp);
  $("#c36Base").textContent = fmtMoney(c.c36);
  $("#c36det").textContent = `${fmtMoney(imp)} / 42`;
  $("#restBase").textContent = fmtMoney(c.resto6);
  $("#c6Base").textContent = fmtMoney(c.c6);

  // con 2ª pareja
  const uG = gamas.find(x=>x.id===state.upgSel);
  const impU = imp + (uG ? uG.upg : 0);
  const cu = calcCuotas(impU);
  $("#impUpg").textContent = fmtMoney(impU);
  $("#c36Upg").textContent = fmtMoney(cu.c36);
  $("#c36detU").textContent = `${fmtMoney(impU)} / 42`;
  $("#restUpg").textContent = fmtMoney(cu.resto6);
  $("#c6Upg").textContent = fmtMoney(cu.c6);
}

/* ====== Render upgrades con regla "no superior" ====== */
function renderUpgrades(){
  const box = $("#upgrades"); box.innerHTML="";
  const idxSel = gamas.findIndex(x=>x.id===state.gamaSel);
  gamas
    .filter(g=>g.id!=="oro") // oro no tiene upg propio (0€) para la pareja; no lo mostramos como “misma gama” de upg
    .slice(0,4) // solo los 4 botones definidos
    .forEach(g=>{
      const u = document.createElement("div");
      u.className="upg";
      // deshabilitar superiores
      const idxG = gamas.findIndex(x=>x.id===g.id);
      const disabled = idxG < idxSel; // si es superior (índice menor -> gama más alta)
      if(disabled) u.classList.add("disabled");
      if(g.id===state.upgSel) u.classList.add("active");
      u.textContent = `${g.nombre} (+${fmtMoney(g.upg)})`;
      u.onclick = ()=>{
        if(disabled) return;
        state.upgSel = g.id;
        saveLS(); renderFin(); renderUpgrades();
      };
      box.appendChild(u);
    });
  // asegurar por defecto "misma gama"
  const gSel = gamas.find(x=>x.id===state.gamaSel);
  if(!gSel) return;
  const idxUpg = gamas.findIndex(x=>x.id===state.upgSel);
  if(idxUpg < idxSel){ // quedó superior por algún motivo → corrige
    state.upgSel = state.gamaSel;
  }
}

/* ====== Compromisos ====== */
function renderComp(){
  $("#txtComp").value = state.comp || "";
  $("#txtComp").disabled = !state.edit;
}

/* ====== Edición (PIN) ====== */
function setEdit(on){
  state.edit = on;
  // botones
  $("#btnEditar").classList.toggle("hidden", on);
  $("#btnGuardar").classList.toggle("hidden", !on);
  // activar inputs de formatos
  renderFormatos();
  // activar textareas
  $("#txtCar").disabled = !on;
  $("#txtComp").disabled = !on;
}
function handleEditar(){
  const pin = $("#pin1").value.trim();
  if(pin !== PIN){ alert("PIN incorrecto"); return; }
  setEdit(true);
}
function handleGuardar(){
  // recoger cambios
  state.car[state.gamaSel] = $("#txtCar").value;
  state.comp = $("#txtComp").value;
  saveLS();
  setEdit(false);
  alert("Guardado ✅");
}

/* ====== Export HTML con datos incrustados (solo lectura) ====== */
function exportHTML(){
  const payload = {
    state,
    gamas,
    formatos,
    factorTAE
  };
  const tpl = `
<!doctype html><html lang="es"><meta charset="utf-8">
<title>Calculadora Infinity (solo lectura)</title>
<style>body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial;margin:20px}
h2{margin:.2em 0}.muted{color:#666}
.box{border:1px solid #e6e6e6;padding:10px;border-radius:8px;margin:6px 0}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
img{max-height:120px;max-width:95%}
@media print{@page{size:A4;margin:12mm}}</style>
<h2>CALCULADORA INFINITY AUDIO</h2>
<div class="muted">Modo visor sin edición – datos incrustados.</div>
<div id="root"></div>
<script>
const data = ${JSON.stringify(payload)};
const fmt = n=>n.toLocaleString("es-ES",{style:"currency",currency:"EUR"});
const root = document.getElementById('root');

function calc(imp){const c36=imp/42;return{c36,resto6:c36*6,c6:c36*${factorTAE}}}
const gSel = data.gamas.find(g=>g.id===data.state.gamaSel);

const imp = gSel.precio;
const cu = calc(imp);

// 2ª pareja
const uG = data.gamas.find(g=>g.id===data.state.upgSel);
const impU = imp + (uG?uG.upg:0);
const cuU = calc(impU);

// formatos
const fmtDiv = document.createElement('div');
fmtDiv.className='grid';
data.formatos.forEach(f=>{
  const d=document.createElement('div');d.className='box';
  d.innerHTML='<div style="font-weight:700">'+f.titulo+'</div>';
  if(data.state.imgs[f.id]){const im=new Image();im.src=data.state.imgs[f.id];d.appendChild(im)}
  root.appendChild(fmtDiv);
  fmtDiv.appendChild(d);
});

// gamas y car
const carDiv=document.createElement('div');carDiv.className='box';
carDiv.innerHTML='<div><b>Gama:</b> '+gSel.nombre+' — '+fmt(gSel.precio)+'</div><pre style="white-space:pre-wrap;margin:.5em 0 0">'+(data.state.car[gSel.id]||'')+'</pre>';
root.appendChild(carDiv);

// fin
const fin=document.createElement('div');fin.className='box';
fin.innerHTML=\`
<b>Financiación Infinity + tchin tchin</b>
<div class="grid" style="margin-top:6px">
  <div class="box"><div>Importe total</div><div>\${fmt(imp)}</div></div>
  <div class="box"><div>Cuota 36m (0%)</div><div><b>\${fmt(cu.c36)}</b></div></div>
  <div class="box"><div>RESTANTE 6M–AHORRO SI RENUEVAS</div><div>\${fmt(cu.resto6)}</div></div>
  <div class="box"><div>Cuota 6m (7,95% TAE)</div><div>\${fmt(cu.c6)}</div></div>

  <div class="box"><div>Importe con 2ª pareja</div><div>\${fmt(impU)}</div></div>
  <div class="box"><div>Cuota 36m (0%)</div><div><b>\${fmt(cuU.c36)}</b></div></div>
  <div class="box"><div>RESTANTE 6M–AHORRO SI RENUEVAS</div><div>\${fmt(cuU.resto6)}</div></div>
  <div class="box"><div>Cuota 6m (7,95% TAE)</div><div>\${fmt(cuU.c6)}</div></div>
</div>\`;
root.appendChild(fin);

// 2ª pareja
const upg=document.createElement('div');upg.className='box';
upg.innerHTML='<b>2º PAREJA RECOMENDADA:</b> '+(uG?uG.nombre+' (+'+fmt(uG.upg)+')':'—');
root.appendChild(upg);

// compromisos
const comp=document.createElement('div');comp.className='box';
comp.innerHTML='<b>COMPROMISOS</b><pre style="white-space:pre-wrap;margin:.5em 0 0">'+(data.state.comp||'')+'</pre>';
root.appendChild(comp);
</script>`;
  const blob = new Blob([tpl],{type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "calculadora_infinity_visor.html";
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);
}

/* ====== Eventos / vínculos ====== */
$("#txtCar").addEventListener("input", ()=>{ if(state.edit){ state.car[state.gamaSel] = $("#txtCar").value; saveLS(); }});
$("#txtComp").addEventListener("input", ()=>{ if(state.edit){ state.comp = $("#txtComp").value; saveLS(); }});
$("#btnEditar").onclick = handleEditar;
$("#btnGuardar").onclick = handleGuardar;
$("#btnPDF").onclick = ()=>window.print();
$("#btnExport").onclick = exportHTML;

/* ====== Render general ====== */
function renderAll(){
  renderFormatos();
  renderGamas();
  renderFin();
  renderUpgrades();
  renderComp();
}
renderAll();
setEdit(false);
</script>
</body>
</html>
