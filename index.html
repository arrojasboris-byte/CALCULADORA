<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CALCULADORA INFINITY AUDIO</title>
<style>
:root{
  --brand:#DC2626; --brand-700:#B91C1C; --bg:#fff; --soft:#f6f7f9;
  --text:#111827; --muted:#6B7280; --line:#E5E7EB; --card:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--soft);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
.container{max-width:1100px;margin:0 auto;padding:20px}
.header{margin-bottom:14px}
.h1{margin:0;line-height:1.1;font-weight:900;color:var(--brand);font-size:44px}
.sub{color:var(--muted);font-size:13px;margin-top:6px}

/* Paper / cards */
.paper{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);overflow:hidden}
.paper .hd{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
.paper .bd{padding:18px}
.row{display:grid;gap:12px}
.grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
.card{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:hidden}
.card .img{height:140px;background:#F9FAFB;display:flex;align-items:center;justify-content:center}
.card .img img{max-width:100%;max-height:100%;object-fit:contain}
.card .cap{padding:8px 10px;color:var(--muted);font-size:12px;text-align:center}
.card.sel{outline:2px solid var(--brand)}

/* Inputs / buttons */
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select,input,textarea{border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px}
textarea{width:100%}
.btn{background:var(--brand);border:0;color:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn:hover{background:var(--brand-700)}
.btn.s{padding:6px 10px;border-radius:8px;font-size:13px}
.btn.ghost{background:#fff;color:var(--text);border:1px solid var(--line)}
.btn.ghost:hover{background:#fafafa}
.note{color:var(--muted);font-size:12px}

/* Tabla de gamas */
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.thead{background:var(--brand);color:#fff}
.thead th{padding:10px 12px;text-align:left;font-weight:700}
tr.item td{padding:10px 12px;background:#fff;border:1px solid var(--line)}
tr.item td:first-child{border-radius:10px 0 0 10px}
tr.item td:last-child{border-radius:0 10px 10px 0}

/* KPIs financiación */
.kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
.kpi{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
.kpi .t{font-size:12px;color:var(--muted)}
.kpi .v{font-size:22px;font-weight:900;margin-top:4px}
.kpi.red{background:var(--brand);border-color:transparent;color:#fff}
.kpi.red .t{color:#fff;opacity:.9}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

/* Upgrade */
.upg{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
.pill{background:var(--brand);color:#fff;border-radius:12px;padding:14px 12px;text-align:center;cursor:pointer;font-weight:700}
.pill.dim{background:#F3F4F6;color:#6B7280;cursor:not-allowed}
.pill.active{box-shadow:0 0 0 2px #fff,0 0 0 4px rgba(220,38,38,.25)}
.badge{display:inline-flex;align-items:center;gap:6px;color:#6B7280}
.badge:before{content:"•";color:var(--brand);font-weight:900}

/* Editor */
.drop{border:2px dashed #e5e7eb;border-radius:12px;padding:10px;text-align:center;color:#6b7280;cursor:pointer}
.drop.drag{background:#fff0f0;border-color:#DC2626;color:#DC2626}

@media print{
  .no-print{display:none!important}
  .container{max-width:none;padding:0 16px}
  body{background:#fff}
}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <h1 class="h1">CALCULADORA INFINITY<br/>AUDIO</h1>
    <div class="sub">36 MESES 0% TAE + 6 MESES 7,95% TAE</div>
  </header>

  <!-- FORMATOS -->
  <section class="paper">
    <div class="hd">
      <strong>Formatos de audífonos</strong>
      <div class="controls no-print">
        <button id="btnEdit" class="btn s">Editar</button>
        <button id="btnSave" class="btn s" style="display:none">Guardar</button>
      </div>
    </div>
    <div class="bd">
      <div id="formatos" class="row grid-4"></div>
      <!-- editor de imágenes -->
      <div id="imgEditor" class="no-print" style="display:none;margin-top:12px">
        <div class="controls">
          <div class="drop" id="dropZone" title="Clic o arrastra imágenes (4 formatos)">
            Arrastra o haz clic para subir imágenes (RIC, BTE, Intracanal estándar, Intracanal a medida)
          </div>
          <input type="file" id="filePick" accept="image/*" multiple style="display:none"/>
        </div>
        <div class="note" style="margin-top:6px">Las imágenes se guardan embebidas (base64) y podrán compartirse en el HTML exportado.</div>
      </div>
    </div>
  </section>

  <!-- CARACTERÍSTICAS -->
  <section class="paper" style="margin-top:12px">
    <div class="hd"><strong>Características de gamas</strong></div>
    <div class="bd">
      <div class="controls">
        <select id="selGama" class="editable" disabled></select>
        <input id="search" class="editable" disabled placeholder="Buscar característica…" style="flex:1"/>
      </div>
      <div style="margin-top:10px">
        <textarea id="txtCar" rows="5" class="editable" disabled></textarea>
        <div class="note" style="margin-top:6px">Edición protegida con PIN 4321. Guardado local y “Descargar HTML con datos”.</div>
      </div>
    </div>
  </section>

  <!-- LISTA GAMAS -->
  <section class="paper" style="margin-top:12px">
    <div class="hd"><strong>Gamas</strong></div>
    <div class="bd">
      <table class="table">
        <thead class="thead"><tr><th>Gama</th><th>Precio</th><th>Características</th></tr></thead>
        <tbody id="tblGamas"></tbody>
      </table>
    </div>
  </section>

  <!-- FINANCIACIÓN -->
  <section class="paper" style="margin-top:12px">
    <div class="hd"><strong>Financiación Infinity</strong></div>
    <div class="bd">
      <div class="kpis">
        <div class="kpi red"><div class="t">Importe base</div><div class="v" id="impBase">—</div></div>
        <div class="kpi"><div class="t">Cuota 36 meses</div><div class="v" id="c36Base">—</div></div>
        <div class="kpi"><div class="t">Importe restante (6m)</div><div class="v" id="restBase">—</div></div>
        <div class="kpi"><div class="t">Financiación 6m (7,95% TAE)</div><div class="v" id="c6Base">—</div></div>
      </div>
      <div style="height:10px"></div>
      <div class="kpis">
        <div class="kpi red"><div class="t">Importe con upgrade</div><div class="v" id="impUpg">—</div></div>
        <div class="kpi"><div class="t">Cuota 36 meses</div><div class="v" id="c36Upg">—</div></div>
        <div class="kpi"><div class="t">Importe restante (6m)</div><div class="v" id="restUpg">—</div></div>
        <div class="kpi"><div class="t">Financiación 6m (7,95% TAE)</div><div class="v" id="c6Upg">—</div></div>
      </div>

      <div class="actions no-print">
        <button class="btn ghost" onclick="window.print()">Guardar PDF</button>
        <button class="btn ghost" id="btnExportHtml">Descargar HTML con datos</button>
        <button class="btn ghost" id="btnExportCsv">Exportar Excel</button>
      </div>
    </div>
  </section>

  <!-- UPGRADE -->
  <section class="paper" style="margin-top:12px">
    <div class="hd"><strong>UPGRADE</strong></div>
    <div class="bd"><div id="upgrades" class="upg"></div></div>
  </section>
</div>

<script>
/* ====== DATOS INCRUSTADOS (se actualiza al exportar) ======
   ¡NO BORRAR!  (Marcadores para el exportador)             */
<!--DATA_START-->
window.__EMBEDDED_STATE = null;
<!--DATA_END-->

/* ================== CONFIG ================== */
const PIN = '4321';
const LS_KEY = 'infinity_calc_v1';

/* ================== DATA ================== */
const FORMATOS = [
  {id:'ric',  nombre:'RIC / RIC Premium'},
  {id:'bte',  nombre:'BTE'},
  {id:'cic',  nombre:'Intracanal estándar'},
  {id:'ite',  nombre:'Intracanal a medida'}
];

// SVG de reserva (si aún no hay imágenes cargadas)
const placeholder = t => "data:image/svg+xml;utf8," + encodeURIComponent(
  "<svg xmlns='http://www.w3.org/2000/svg' width='600' height='420'>"
 + "<rect x='10' y='10' width='580' height='400' rx='16' ry='16' fill='#F9FAFB' stroke='#E5E7EB' stroke-width='3'/>"
 + "<text x='300' y='220' font-family='Arial' font-size='26' fill='#9CA3AF' text-anchor='middle'>"+t+"</text></svg>"
);

const GAMAS = [
  {id:'diamante_plus', nombre:'Diamante Plus', precio:3995, upgNombre:'Diamante Plus (+2004)', upgImporte:2004},
  {id:'diamante',      nombre:'Diamante',      precio:3895, upgNombre:'Diamante (+1904)',      upgImporte:1904},
  {id:'platino_plus',  nombre:'Platino Plus',  precio:3395, upgNombre:'Platino Plus (+1404)',  upgImporte:1404},
  {id:'platino',       nombre:'Platino',       precio:3295, upgNombre:'Platino (+1294)',       upgImporte:1294},
  {id:'oro',           nombre:'Oro',           precio:1991, upgNombre:'—',                     upgImporte:0   },
];

/* ================== STATE ================== */
let stateDefault = {
  formato:'ric',
  gamaId:'diamante_plus',
  pinOk:false,
  upgradeId:'diamante_plus',  // recomendado por defecto
  upgradeActivo:true,
  imagenes:{                  // se rellenan con tus imágenes
    ric:null,bte:null,cic:null,ite:null
  },
  caracteristicas:{
    diamante_plus:'• Prestaciones máximas\n• 16 canales\n• Reducción de ruido avanzada\n• Bluetooth LE',
    diamante:'• Gran rendimiento\n• 14 canales\n• Control inteligencia ambiental',
    platino_plus:'• 12 canales\n• IP67\n• Carga rápida',
    platino:'• 10 canales\n• Control básico de ruido',
    oro:'• 6 canales\n• Esencial'
  }
};

// 1) Si viene HTML con datos incrustados, usarlo
let state = window.__EMBEDDED_STATE ? window.__EMBEDDED_STATE : stateDefault;

// 2) Si hay localStorage, tiene prioridad (para seguir editando)
try{
  const s=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
  if(s && Object.keys(s).length){ state={...state,...s}; }
}catch{}

/* ================== HELPERS ================== */
const $=(q,c=document)=>c.querySelector(q);
const $$=(q,c=document)=>Array.from(c.querySelectorAll(q));
const money=n=> n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+' €';
const mensualidad=(p,m,t)=>{const r=t/12;if(!r)return p/m;const pow=Math.pow(1+r,m);return p*(r*pow)/(pow-1)};
const save=()=>localStorage.setItem(LS_KEY, JSON.stringify(state));
const gamaById=id=>GAMAS.find(g=>g.id===id);

/* ================== RENDER ================== */
function renderFormatos(){
  const wrap=$("#formatos"); wrap.innerHTML='';
  FORMATOS.forEach(f=>{
    const c=document.createElement('div');
    c.className='card'+(state.formato===f.id?' sel':'');
    const src = state.imagenes[f.id] || placeholder(f.nombre);
    c.innerHTML=`<div class="img"><img src="${src}" alt=""></div><div class="cap">${f.nombre}</div>`;
    c.onclick=()=>{state.formato=f.id; save(); renderFormatos();}
    wrap.appendChild(c);
  });
}
function renderSelectGama(){
  const sel=$("#selGama");
  sel.innerHTML=GAMAS.map(g=>`<option value="${g.id}">${g.nombre}</option>`).join('');
  sel.value=state.gamaId;
}
function renderTablaGamas(){
  const tb=$("#tblGamas"); tb.innerHTML='';
  GAMAS.forEach(g=>{
    const tr=document.createElement('tr'); tr.className='item';
    const checked=(state.gamaId===g.id)?'checked':'';
    const mini=(state.caracteristicas[g.id]||'').split('\n').filter(Boolean);
    tr.innerHTML=`
      <td style="width:250px">
        <label style="display:flex;gap:8px;align-items:center;cursor:pointer">
          <input type="radio" name="rg" value="${g.id}" ${checked}/>
          <strong>${g.nombre}</strong>
        </label>
      </td>
      <td style="width:130px">${money(g.precio)}</td>
      <td><span class="badge">Ver características (${mini.length})</span></td>`;
    tr.querySelector('input').onchange=()=>{
      state.gamaId=g.id;
      state.upgradeId=g.id; state.upgradeActivo=true; // recomendado
      save(); renderSelectGama(); renderUpgrades(); calc();
    };
    tr.querySelector('.badge').onclick=()=>alert(`${g.nombre}\n\n${state.caracteristicas[g.id]||'Sin características'}`);
    tb.appendChild(tr);
  });
}
function renderUpgrades(){
  const box=$("#upgrades"); box.innerHTML='';
  const idx=GAMAS.findIndex(g=>g.id===state.gamaId);
  GAMAS.forEach(g=>{
    const superior = (GAMAS.indexOf(g) < idx); // superiores deshabilitadas
    const active = state.upgradeActivo && (state.upgradeId===g.id);
    const div=document.createElement('div');
    div.className='pill '+(superior?'dim':(active?'active':'')); 
    div.textContent=g.upgNombre;
    div.title= superior ? 'Solo misma gama o inferior' : '';
    div.onclick=()=>{
      if(superior) return;
      if(g.id===state.gamaId){
        state.upgradeActivo=!state.upgradeActivo; // toggle recomendado
      }else{
        state.upgradeId=g.id; state.upgradeActivo=true; // elegir inferior
      }
      save(); renderUpgrades(); calc();
    };
    box.appendChild(div);
  });
}
function toggleEdit(){
  const on=state.pinOk;
  $$('.editable').forEach(el=>el.disabled=!on);
  $('#btnSave').style.display=on?'inline-flex':'none';
  $('#imgEditor').style.display=on?'block':'none';
}
function calc(){
  const g=gamaById(state.gamaId);
  const imp=g.precio, c36=imp/42, rest=imp-c36*36, c6=mensualidad(rest,6,0.0795);
  $('#impBase').textContent=money(imp);
  $('#c36Base').textContent=money(c36);
  $('#restBase').textContent=money(rest);
  $('#c6Base').textContent=money(c6);

  let upg=0;
  if(state.upgradeActivo){
    const ug=gamaById(state.upgradeId);
    upg = ug ? (ug.upgImporte||0) : 0;
  }
  const tot=imp+upg, c36u=tot/42, restu=tot-c36u*36, c6u=mensualidad(restu,6,0.0795);
  $('#impUpg').textContent=money(tot);
  $('#c36Upg').textContent=money(c36u);
  $('#restUpg').textContent=money(restu);
  $('#c6Upg').textContent=money(c6u);
}

/* ================== EDITAR ================== */
function bindEdit(){
  $('#btnEdit').onclick=()=>{
    const p=prompt('Introduce PIN');
    if(p===PIN){ state.pinOk=true; save(); toggleEdit(); }
    else alert('PIN incorrecto');
  };
  $('#btnSave').onclick=()=>{ save(); alert('Guardado ✅'); };

  $('#selGama').onchange=e=>{
    state.gamaId=e.target.value; state.upgradeId=state.gamaId; state.upgradeActivo=true;
    save(); renderTablaGamas(); renderUpgrades(); calc();
    $('#txtCar').value=state.caracteristicas[state.gamaId]||'';
  };
  $('#txtCar').oninput=e=>{
    state.caracteristicas[$('#selGama').value]=e.target.value;
  };
  $('#search').oninput=e=>{
    const v=e.target.value.toLowerCase();
    const key=$('#selGama').value;
    const src=(state.caracteristicas[key]||'').split('\n').filter(Boolean);
    $('#txtCar').value = v ? src.filter(x=>x.toLowerCase().includes(v)).join('\n') : (state.caracteristicas[key]||'');
  };

  // Subida de imágenes
  const dz = $('#dropZone'), fp = $('#filePick');
  const handleFiles = files=>{
    [...files].forEach(f=>{
      const r=new FileReader();
      r.onload=()=>{
        // orden: ric,bte,cic,ite – rellenamos el primero que falte
        for(const id of ['ric','bte','cic','ite']){
          if(!state.imagenes[id]){ state.imagenes[id]=r.result; break; }
        }
        save(); renderFormatos();
      };
      r.readAsDataURL(f);
    });
  };
  dz.onclick=()=>fp.click();
  dz.ondragover=e=>{e.preventDefault();dz.classList.add('drag');};
  dz.ondragleave=()=>dz.classList.remove('drag');
  dz.ondrop=e=>{e.preventDefault();dz.classList.remove('drag'); handleFiles(e.dataTransfer.files);};
  fp.onchange=e=>handleFiles(e.target.files);
}

/* ================== EXPORTAR ================== */
function download(filename, text){
  const blob=new Blob([text],{type:'text/html;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download=filename;document.body.appendChild(a);a.click();a.remove();
}
function exportHtmlWithData(){
  // Clonar estado y quitar flags volátiles
  const data = JSON.parse(JSON.stringify(state));
  data.pinOk = false; // no exportamos sesión abierta

  // Insertar JSON dentro de esta misma página (entre DATA_START / DATA_END)
  let html = document.documentElement.outerHTML;
  const json = "window.__EMBEDDED_STATE = " + JSON.stringify(data) + ";";
  html = html.replace(/<!--DATA_START-->[\\s\\S]*?<!--DATA_END-->/,
                      "<!--DATA_START-->\n"+json+"\n<!--DATA_END-->");
  download("calculadora_infinity_con_datos.html", html);
}
function exportCSV(){
  const g=gamaById(state.gamaId);
  const imp=g.precio, c36=imp/42, rest=imp-c36*36, c6=mensualidad(rest,6,0.0795);
  const ug=gamaById(state.upgradeId);
  const upgVal=state.upgradeActivo?(ug.upgImporte||0):0, upgNom=state.upgradeActivo?ug.upgNombre:'—';
  const tot=imp+upgVal, c36u=tot/42, restu=tot-c36u*36, c6u=mensualidad(restu,6,0.0795);

  const rows=[['Gama','Precio','Cuota36','Restante6m','Cuota6m','Upgrade','ImporteUpg','Total','Cuota36Upg','Restante6mUpg','Cuota6mUpg'],
              [g.nombre,imp,c36,rest,c6,upgNom,upgVal,tot,c36u,restu,c6u]];
  const csv=rows.map(r=>r.join(';')).join('\\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='calculadora_infinity.csv';a.click();
}

/* ================== INIT ================== */
function init(){
  renderFormatos();
  renderSelectGama();
  renderTablaGamas();
  renderUpgrades();
  toggleEdit();
  bindEdit();
  $('#txtCar').value=state.caracteristicas[state.gamaId]||'';
  calc();

  $('#btnExportHtml').onclick=exportHtmlWithData;
  $('#btnExportCsv').onclick=exportCSV;
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
