<script>
/* ===== Config ===== */
const GAMAS=[
  {id:"diamantePlus", nombre:"Diamante Plus", precio:3995, upg:2004},
  {id:"diamante",     nombre:"Diamante",      precio:3895, upg:1904},
  {id:"platinoPlus",  nombre:"Platino Plus",  precio:3395, upg:1404},
  {id:"platino",      nombre:"Platino",       precio:3295, upg:1304},
  {id:"oro",          nombre:"Oro",           precio:1991, upg:0}
];
// Orden inferior → superior
const ORDER=["oro","platino","platinoPlus","diamante","diamantePlus"];
const $=s=>document.querySelector(s);
const fmt=n=>n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+' €';
const mensualidad=(p,m,t)=>{const r=t/12;if(!r)return p/m;const pow=Math.pow(1+r,m);return p*(r*pow)/(pow-1);} ;

/* ===== Estado ===== */
const DEFAULT={
  gamaId:"diamantePlus",
  car:{
    diamantePlus:'Gran rendimiento\n16 canales\nControl inteligencia ambiental',
    diamante:'Gran rendimiento\n14 canales\nControl inteligencia ambiental',
    platinoPlus:'Rendimiento alto\n12 canales\nReducción de ruido',
    platino:'Buen rendimiento\n10 canales\nBluetooth',
    oro:'Funcional para todas las pérdidas auditivas\nConfort en ambiente silencioso\nPilas\nPrograma de Tinnitus'
  },
  compromisos:"• Compromiso 1\n• Compromiso 2",
  imagenes:[null,null,null,null],
  upgradeSel:"diamantePlus"
};
let state=DEFAULT;
try{const s=JSON.parse(localStorage.getItem("calc_infy_state")||"{}");state={...DEFAULT,...s};}catch{}

/* ===== Helpers ===== */
const gamaById=id=>GAMAS.find(g=>g.id===id);

/* ===== Gamas ===== */
function renderGamas(){
  const box=$("#gamas"); box.innerHTML="";
  GAMAS.forEach(g=>{
    const pill=document.createElement("div");
    pill.className="pill "+(state.gamaId===g.id?"sel":"");
    pill.innerHTML=`<span>${g.nombre}</span><span class="price">${fmt(g.precio)}</span>`;
    pill.onclick=()=>{ state.gamaId=g.id; ensureUpgradeRange(true); save(); renderAll(); };
    box.appendChild(pill);
  });
  $("#carTitle").textContent=gamaById(state.gamaId).nombre;
}

/* ===== Control de 2º pareja recomendada ===== */
function ensureUpgradeRange(resetSame=false){
  const idxSel=ORDER.indexOf(state.gamaId);
  // si la recomendación actual es superior, se fuerza a la misma
  if(ORDER.indexOf(state.upgradeSel)>idxSel || resetSame){
    state.upgradeSel=state.gamaId;
  }
}

function renderUpgrades(){
  const box=$("#upBox"); box.innerHTML="";
  const idxSel=ORDER.indexOf(state.gamaId);
  GAMAS.filter(g=>g.id!=="oro").forEach(g=>{
    const idxG=ORDER.indexOf(g.id);
    const isSuperior=idxG>idxSel; // superior si índice mayor
    const btn=document.createElement("button");
    btn.className="up"+(isSuperior?" disabled":(state.upgradeSel===g.id?" red":""));
    btn.textContent=`${g.nombre} (+${g.upg.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})}€)`;
    if(!isSuperior){
      btn.onclick=()=>{ state.upgradeSel=g.id; save(); renderUpgrades(); calc(); };
    }
    box.appendChild(btn);
  });
  // asegura que la recomendación nunca quede superior
  if(ORDER.indexOf(state.upgradeSel)>idxSel){ state.upgradeSel=state.gamaId; }
}

/* ===== Textos ===== */
function fill(){
  $("#txtCar").value=(state.car[state.gamaId]||"").replace(/\r?\n/g,"\n");
  $("#txtComp").value=(state.compromisos||"").replace(/\r?\n/g,"\n");
}

/* ===== Imágenes ===== */
function renderImgs(){
  state.imagenes.forEach((u,i)=>{
    const im=$("#img"+i);
    if(im){ im.src=u||""; im.style.opacity=u?1:.35; }
  });
}
function bindImgEditors(on){
  document.querySelectorAll(".img-edit").forEach(x=>x.classList.toggle("hidden",!on));
  $("#tipImgs").classList.toggle("hidden",!on);
  document.querySelectorAll(".card img").forEach((img,i)=>{
    img.style.cursor=on?"pointer":"default";
    img.onclick=on?()=>chooseImage(i):null;
  });
  document.querySelectorAll(".img-edit button").forEach(btn=>{
    const idx=+btn.getAttribute("data-idx");
    if(btn.textContent==="Borrar"){
      btn.onclick=on?()=>{state.imagenes[idx]=null;save();renderImgs();}:null;
    }else{
      btn.onclick=on?()=>chooseImage(idx):null;
    }
  });
}
function chooseImage(i){
  const picker=$("#filePicker");
  picker.onchange=()=>{
    const f=picker.files&&picker.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=()=>{state.imagenes[i]=r.result;save();renderImgs();picker.value="";};
    r.readAsDataURL(f);
  };
  picker.click();
}

/* ===== Cálculos ===== */
function calc(){
  const g=gamaById(state.gamaId);
  const base=g.precio;
  const c36=base/42;
  const rest=base-36*c36;
  const c6=mensualidad(rest,6,0.0795);
  $("#impBase").textContent=fmt(base);
  $("#c36").textContent=fmt(c36);
  $("#c36det").textContent=`${fmt(base)} / 42`;
  $("#res6").textContent=fmt(rest);
  $("#c6").textContent=fmt(c6);

  ensureUpgradeRange();
  const ug=gamaById(state.upgradeSel);
  const tot=base+(ug?.upg||0);
  const c36u=tot/42;
  const restu=tot-36*c36u;
  const c6u=mensualidad(restu,6,0.0795);
  $("#impUp").textContent=fmt(tot);
  $("#c36u").textContent=fmt(c36u);
  $("#c36udet").textContent=`${fmt(tot)} / 42`;
  $("#res6u").textContent=fmt(restu);
  $("#c6u").textContent=fmt(c6u);
}

/* ===== PIN / edición ===== */
let pinOk=false;
function toggleEditUI(){
  const on=pinOk;
  $("#btnEdit").classList.toggle("hidden",on);
  $("#btnSave").classList.toggle("hidden",!on);
  $("#txtCar").readOnly=!on;
  $("#txtComp").readOnly=!on;
  bindImgEditors(on);
}
function askPin(){
  const dlg=$("#dlg");
  return new Promise((res)=>{
    if(dlg&&dlg.showModal){
      const pin=$("#pin"),ok=$("#okPin"),msg=$("#pinMsg");msg.textContent="";pin.value="";
      dlg.showModal();
      ok.onclick=(ev)=>{ev.preventDefault();
        const v=(pin&&pin.value||"").trim();
        if(v==="4321"){dlg.close();res(true);}else{msg.textContent="PIN incorrecto";}
      };
      dlg.addEventListener("close",()=>res(false),{once:true});
    }else{
      const v=(prompt("Introduce PIN")||"").trim();res(v==="4321");
    }
  });
}
$("#btnEdit").onclick=async()=>{const ok=await askPin();if(ok){pinOk=true;toggleEditUI();}};
$("#btnSave").onclick=()=>{
  const g=state.gamaId;
  state.car[g]=$("#txtCar").value;
  state.compromisos=$("#txtComp").value;
  save();pinOk=false;toggleEditUI();alert("Guardado ✓");
};

/* ===== Guardado ===== */
function save(){localStorage.setItem("calc_infy_state",JSON.stringify(state));}

/* ===== Export / PDF ===== */
$("#btnHtml").onclick=()=>{
  const html=document.documentElement.outerHTML
  .replace("</head>","<script>window.__EMBEDDED_STATE="+JSON.stringify(state)+"</script></head>");
  const blob=new Blob([html],{type:"text/html"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="calculadora_infinity_audio.html";
  a.click();
  URL.revokeObjectURL(a.href);
};
$("#btnPDF").onclick=()=>window.print();

/* ===== Boot ===== */
(function(){
  if(window.__EMBEDDED_STATE){state={...DEFAULT,...window.__EMBEDDED_STATE};}
  renderGamas();renderUpgrades();fill();renderImgs();calc();toggleEditUI();
})();
</script>
