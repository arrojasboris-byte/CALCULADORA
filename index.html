<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CALCULADORA INFINITY AUDIO</title>
<style>
:root{
  --rojo:#D7302F; --gris:#f2f3f5; --borde:#e5e7eb; --texto:#222; --texto-suave:#6b7280;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#fff;color:var(--texto);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
.wrapper{width:960px;margin:24px auto 64px auto}
h1{margin:0 0 4px 0;font-size:44px;letter-spacing:.5px}
.sub{margin:0 0 18px 0;color:var(--texto-suave);font-size:14px}
.faldon{background:var(--rojo);color:#fff;padding:10px 14px;border-radius:8px 8px 0 0;font-weight:700;font-size:14px;display:flex;align-items:center;justify-content:space-between}
.card{background:#fff;border:1px solid var(--borde);border-top:0;border-radius:0 0 8px 8px;padding:14px}
.row{display:flex;gap:14px;flex-wrap:wrap}
.col{flex:1 1 0}
.box{background:var(--gris);border:1px dashed #d8dbe1;border-radius:12px;height:150px;display:flex;align-items:center;justify-content:center;color:#9aa0a6;font-weight:700}
.small{height:120px}
label.tag{display:inline-block;background:#fff;border:1px solid var(--borde);border-radius:10px;padding:10px 12px;width:100%;cursor:pointer}
label.tag.active{outline:2px solid var(--rojo)}
.tag .precio{float:right;color:#111;font-weight:700}
.badge{display:inline-block;background:#ffecee;color:#c02121;padding:2px 6px;border-radius:6px;font-size:12px;font-weight:700}
.kpi{background:#fff;border:1px solid var(--borde);border-radius:10px;padding:14px;height:88px;display:flex;flex-direction:column;gap:6px;justify-content:center}
.kpi .t{font-size:12px;color:var(--texto-suave)}
.kpi .v{font-size:18px;font-weight:800}
.kpi.red .v{color:#d61c2f}
.actions{display:flex;gap:10px;margin-top:10px}
.btn{border:0;border-radius:10px;background:#eceff3;color:#111;padding:10px 12px;cursor:pointer;font-weight:700}
.btn.red{background:var(--rojo);color:#fff}
.btn.ghost{background:#fff;border:1px solid var(--borde)}
.btn:disabled{opacity:.45;cursor:not-allowed}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
.help{color:var(--texto-suave);font-size:12px}
.hidden{display:none}
.hr{height:1px;background:var(--borde);margin:10px 0}
.pad{padding:10px}
textarea.input{width:100%;min-height:140px;border:1px solid var(--borde);border-radius:10px;padding:10px;font-family:inherit}
.input[disabled]{background:#fafafa}
.center{display:flex;align-items:center;gap:8px}
.pill{border-radius:999px;padding:10px 12px;border:1px solid var(--borde);background:#fff;cursor:pointer;font-weight:700}
.pill.red{background:var(--rojo);border-color:var(--rojo);color:#fff}
.pill.disabled{opacity:.4;cursor:not-allowed}
.header-line{display:flex;align-items:center;justify-content:space-between;margin:0 0 8px 0}
</style>
</head>
<body>
<div class="wrapper">

  <h1>CALCULADORA INFINITY<br/>AUDIO</h1>
  <div class="sub">36 meses 0%TAE + 6 meses 7,95% TAE</div>

  <!-- FORMATOS -->
  <div class="faldon">
    <div>Formatos de audífonos</div>
    <div class="center">
      <button id="btnEdit" class="btn ghost">Editar</button>
      <button id="btnSave" class="btn red hidden">Guardar</button>
    </div>
  </div>
  <div class="card">
    <div class="row">
      <div class="col">
        <div class="box" id="fmt_ric_box">RIC / RIC Premium</div>
        <div class="help">RIC / RIC Premium</div>
        <input type="file" id="fmt_ric" class="hidden" accept="image/*" />
      </div>
      <div class="col">
        <div class="box" id="fmt_bte_box">BTE</div>
        <div class="help">BTE</div>
        <input type="file" id="fmt_bte" class="hidden" accept="image/*" />
      </div>
      <div class="col">
        <div class="box" id="fmt_ite_box">Intracanal estándar</div>
        <div class="help">Intracanal estándar</div>
        <input type="file" id="fmt_ite" class="hidden" accept="image/*" />
      </div>
      <div class="col">
        <div class="box" id="fmt_cic_box">Intracanal a medida</div>
        <div class="help">Intracanal a medida</div>
        <input type="file" id="fmt_cic" class="hidden" accept="image/*" />
      </div>
    </div>
  </div>

  <!-- GAMAS -->
  <div class="faldon">Características y gamas</div>
  <div class="card">
    <div class="grid2">
      <div>
        <div style="display:grid;gap:8px">
          <label class="tag" data-gama="Diamante Plus"><span>Diamante Plus</span> <span class="precio">3995,00 €</span></label>
          <label class="tag" data-gama="Diamante"><span>Diamante</span> <span class="precio">3895,00 €</span></label>
          <label class="tag" data-gama="Platino Plus"><span>Platino Plus</span> <span class="precio">3395,00 €</span></label>
          <label class="tag" data-gama="Platino"><span>Platino</span> <span class="precio">3295,00 €</span></label>
          <label class="tag" data-gama="Oro"><span>Oro</span> <span class="precio">1991,00 €</span></label>
        </div>
      </div>
      <div>
        <div class="header-line">
          <div><b id="carTitle">Características – Diamante Plus</b></div>
          <div class="help">Para editar introduce el PIN en “Editar”.</div>
        </div>
        <textarea id="carText" class="input textarea" disabled></textarea>
      </div>
    </div>
  </div>

  <!-- FINANCIACIÓN -->
  <div class="faldon">Financiación Infinity + tchin tchin</div>
  <div class="card">
    <div class="grid4">
      <div class="kpi">
        <div class="t">Importe total</div>
        <div class="v" id="impTotal">—</div>
        <div class="help" id="impTotalHelp"></div>
      </div>
      <div class="kpi red">
        <div class="t">Cuota 36m (0%)</div>
        <div class="v" id="c36">—</div>
        <div class="help" id="c36h"></div>
      </div>
      <div class="kpi">
        <div class="t">RESTANTE 6M – AHORRO SI RENUEVAS</div>
        <div class="v" id="rest6">—</div>
      </div>
      <div class="kpi">
        <div class="t">Cuota 6m (7,95% TAE)</div>
        <div class="v" id="c6">—</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="grid4">
      <div class="kpi">
        <div class="t">Importe con 2ª pareja</div>
        <div class="v" id="imp2">—</div>
        <div class="help" id="imp2h"></div>
      </div>
      <div class="kpi red">
        <div class="t">Cuota 36m (0%)</div>
        <div class="v" id="c36_2">—</div>
        <div class="help" id="c36_2h"></div>
      </div>
      <div class="kpi">
        <div class="t">RESTANTE 6M – AHORRO SI RENUEVAS</div>
        <div class="v" id="rest6_2">—</div>
      </div>
      <div class="kpi">
        <div class="t">Cuota 6m (7,95% TAE)</div>
        <div class="v" id="c6_2">—</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btnPDF">Guardar PDF</button>
      <button class="btn ghost" id="btnExport">Descargar HTML con datos (solo lectura)</button>
    </div>
  </div>

  <!-- 2ª PAREJA -->
  <div class="faldon">2º PAREJA RECOMENDADA</div>
  <div class="card">
    <div class="help" style="margin-bottom:8px">Se muestra en rojo la de la misma gama; las superiores se deshabilitan.</div>
    <div class="row">
      <button class="pill" data-upg="Diamante Plus">Diamante Plus (+2004€)</button>
      <button class="pill" data-upg="Diamante">Diamante (+1904€)</button>
      <button class="pill" data-upg="Platino Plus">Platino Plus (+1404€)</button>
      <button class="pill" data-upg="Platino">Platino (+1304€)</button>
    </div>
  </div>

  <!-- COMPROMISOS -->
  <div class="faldon">COMPROMISOS</div>
  <div class="card">
    <button class="btn ghost" id="btnComp">Mostrar / ocultar</button>
    <div id="compWrap" class="pad">
      <textarea id="compText" class="input textarea" placeholder="Escribe aquí los compromisos (uno por línea)..." disabled></textarea>
      <div class="help">Editable con PIN (botón “Editar”).</div>
    </div>
  </div>

</div>

<script>
/* ====== Datos base ====== */
const PRICES = {
  "Diamante Plus": 3995, "Diamante": 3895, "Platino Plus": 3395, "Platino": 3295, "Oro": 1991
};
const UPG_DIFF = {
  "Diamante Plus": 2004, "Diamante": 1904, "Platino Plus": 1404, "Platino": 1304
};
const ORDER = ["Diamante Plus","Diamante","Platino Plus","Platino","Oro"];
const TAE6 = 0.0795;

/* ====== Estado ====== */
const S = JSON.parse(localStorage.getItem("calc_infy_v1")||"{}");
if(!S.gama) S.gama = "Diamante Plus";
if(!S.car)  S.car = {
  "Diamante Plus":"• Amplio ancho de bandas-canales de programación.\n• Bluetooth universal.\n• Streaming de audio directo.\n• Tcoil.\n• Recargable.\n• Multifoco/detección hablantes / autonomía batería ~5h.\n• Ajuste en remoto.\n• Programa Tinnitus.",
  "Diamante":"• Gran rendimiento.\n• 14 canales.\n• Control inteligencia ambiental",
  "Platino Plus":"• Alta relación calidad/precio.\n• Buen desempeño en ruido moderado.",
  "Platino":"• Rendimiento sólido.\n• 12 canales.",
  "Oro":"• Funcional para todas las pérdidas auditivas.\n• Confort en ambiente silencioso.\n• Pila.\n• Programa de Tinnitus.\n• Ancho de banda más limitado."
};
if(!S.comp) S.comp = "• Compromiso 1\n• Compromiso 2";
if(!S.upg)  S.upg  = "Diamante Plus";

const E = (q)=>document.querySelector(q);
const $$ = (q)=>document.querySelectorAll(q);

/* ====== Helpers ====== */
const fmt = (n)=> n===null?"—": n.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})+" €";
function cuotaMensual(monto, meses, interes){
  if(interes<=0) return monto/meses;
  const r = interes/12;
  return monto * (r*Math.pow(1+r, meses))/(Math.pow(1+r, meses)-1);
}
function guardar(){
  localStorage.setItem("calc_infy_v1", JSON.stringify(S));
}

/* ====== UI Inicial ====== */
function pintarGamas(){
  $$(".tag").forEach(l=>{
    l.classList.toggle("active", l.dataset.gama===S.gama);
  });
  E("#carTitle").textContent = "Características – "+S.gama;
  E("#carText").value = S.car[S.gama]||"";
}
function pintarComp(){ E("#compText").value = S.comp||""; }
function bloquearEdicion(lock){
  E("#carText").disabled = lock;
  E("#compText").disabled = lock;
  ["fmt_ric","fmt_bte","fmt_ite","fmt_cic"].forEach(id=>{
    E("#"+id).classList.toggle("hidden", lock);
  });
  E("#btnEdit").classList.toggle("hidden", !lock);
  E("#btnSave").classList.toggle("hidden", lock);
}
function cargarImagen(idBox, key){
  const data = S[key];
  const box = E(idBox);
  if(data){
    box.style.background = `#fff url(${data}) center/contain no-repeat`;
    box.textContent = "";
  }else{
    box.style.background="var(--gris)";
    box.textContent = box.dataset ?? box.textContent;
  }
}
function pintarFormatos(){
  cargarImagen("#fmt_ric_box","img_ric");
  cargarImagen("#fmt_bte_box","img_bte");
  cargarImagen("#fmt_ite_box","img_ite");
  cargarImagen("#fmt_cic_box","img_cic");
}

/* ====== Financiación ====== */
function recalcular(){
  const base = PRICES[S.gama];
  E("#impTotal").textContent = fmt(base);
  E("#impTotalHelp").textContent = "";
  const c36 = cuotaMensual(base,36,0);
  const c6  = cuotaMensual(base,6,TAE6);
  E("#c36").textContent = fmt(c36);
  E("#c36h").textContent = `${fmt(base)} / 42`;
  E("#c6").textContent  = fmt(c6);
  E("#rest6").textContent = fmt(base - c36*36);

  // 2ª pareja (mismo u inferior)
  let up = S.upg;
  if(ORDER.indexOf(up)<ORDER.indexOf(S.gama)) up = S.gama; // seguridad
  if(ORDER.indexOf(up)>ORDER.indexOf(S.gama)) up = S.gama; // nunca superior

  const upImporte = PRICES[up] + (UPG_DIFF[up]||0);
  E("#imp2").textContent = fmt(upImporte);
  E("#imp2h").textContent = `${fmt(upImporte)} / 42`;
  const c36_2 = cuotaMensual(upImporte,36,0);
  const c6_2  = cuotaMensual(upImporte,6,TAE6);
  E("#c36_2").textContent = fmt(c36_2);
  E("#c36_2h").textContent = `${fmt(upImporte)} / 42`;
  E("#c6_2").textContent  = fmt(c6_2);
  E("#rest6_2").textContent = fmt(upImporte - c36_2*36);

  // botones de upg (rojo la misma, deshabilitar superiores)
  $$(".pill").forEach(b=>{
    const g = b.dataset.upg;
    const superior = ORDER.indexOf(g) < ORDER.indexOf(S.gama);
    b.classList.toggle("red", g===S.gama);
    b.classList.toggle("disabled", superior); // superiores deshabilitadas
    b.disabled = superior;
  });
}

/* ====== Eventos ====== */
// elegir gama
$$(".tag").forEach(l=>{
  l.addEventListener("click",()=>{
    S.gama = l.dataset.gama;
    // si la 2ª pareja quedó superior, corrige
    if(ORDER.indexOf(S.upg)<ORDER.indexOf(S.gama)) S.upg = S.gama;
    pintarGamas(); recalcular(); guardar();
  });
});

// upg
$$(".pill").forEach(b=>{
  b.addEventListener("click",()=>{
    const g = b.dataset.upg;
    if(ORDER.indexOf(g) < ORDER.indexOf(S.gama)) return; // nunca superior
    S.upg = g;
    recalcular(); guardar();
  });
});

// editar/guardar con PIN
E("#btnEdit").addEventListener("click",()=>{
  const pin = prompt("PIN de edición:");
  if(pin==="4321"){ bloquearEdicion(false); }
  else alert("PIN incorrecto");
});
E("#btnSave").addEventListener("click",()=>{
  S.car[S.gama] = E("#carText").value;
  S.comp = E("#compText").value;
  guardar();
  bloquearEdicion(true);
  alert("Guardado");
});

// toggle compromisos
E("#btnComp").addEventListener("click",()=>{
  E("#compWrap").classList.toggle("hidden");
});

// exportar HTML con datos
E("#btnExport").addEventListener("click",()=>{
  const blob = new Blob([document.documentElement.outerHTML],{type:"text/html"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "calculadora_infinity_offline.html";
  a.click();
});

// PDF (usa diálogo de impresión)
E("#btnPDF").addEventListener("click",()=>{ window.print(); });

// carga de imágenes
[
  {input:"#fmt_ric", box:"#fmt_ric_box", key:"img_ric"},
  {input:"#fmt_bte", box:"#fmt_bte_box", key:"img_bte"},
  {input:"#fmt_ite", box:"#fmt_ite_box", key:"img_ite"},
  {input:"#fmt_cic", box:"#fmt_cic_box", key:"img_cic"}
].forEach(({input,box,key})=>{
  E(box).addEventListener("click",()=>{ if(!E("#btnSave").classList.contains("hidden")) E(input).click(); });
  E(input).addEventListener("change",(ev)=>{
    const f = ev.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = (e)=>{ S[key]=e.target.result; guardar(); pintarFormatos(); };
    r.readAsDataURL(f);
  });
});

/* ====== Init ====== */
pintarGamas(); pintarFormatos(); pintarComp(); bloquearEdicion(true); recalcular();
</script>
</body>
</html>
