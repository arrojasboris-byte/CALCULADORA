<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CALCULADORA INFINITY AUDIO</title>
  <meta name="color-scheme" content="light" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme:{ extend:{ colors:{ brand:{ red:'#DC2626', gray:'#6B7280' }}}}}
  </script>
  <style>
    html, body { background:#f6f7f9; }
    .paper { background:white; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .imgBox { aspect-ratio:1/1; }
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 1rem;
      padding: 1rem;
      text-align: center;
      color: #888;
      transition: background .2s, border .2s;
      cursor: pointer;
    }
    .drop-zone.dragover {
      background: #fef2f2;
      border-color: #dc2626;
      color: #dc2626;
    }
    @media print { .no-print { display:none !important; } html, body { background:white; } }
  </style>
</head>
<body class="min-h-screen text-gray-900">
  <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">

    <header class="space-y-1">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-red-700 leading-tight">
        CALCULADORA INFINITY<br/>AUDIO
      </h1>
      <p class="text-sm text-gray-600">36 meses sin intereses · 6 meses con 7,95% TAE</p>
    </header>

    <!-- Características -->
    <section class="paper rounded-2xl overflow-hidden">
      <div class="p-4 md:p-6 border-b flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-700">Características de gamas</h2>
        <button id="btn-edit" class="text-xs px-3 py-1.5 rounded-lg bg-red-600 text-white hover:bg-red-700 no-print">
          Editar contenido
        </button>
      </div>

      <div class="p-4 md:p-6 space-y-4">
        <div id="caracteristicas" class="whitespace-pre-wrap text-sm text-gray-800"></div>
        <div id="galeria" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
      </div>
    </section>

    <!-- Financiación (cálculo fijo) -->
    <section class="paper rounded-2xl p-4 md:p-6 space-y-4">
      <h3 class="text-sm font-semibold text-gray-700">Financiación Infinity</h3>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="bg-red-600 text-white rounded-xl p-4">
          <div class="text-xs opacity-90 mb-1">Importe total (Diamante Plus)</div>
          <div class="text-3xl font-extrabold"><span id="importe">3995,00 €</span></div>
          <div class="text-[11px] opacity-90 mt-1">sin intereses</div>
        </div>
        <div class="bg-white rounded-xl p-4 border"><div class="text-xs text-gray-600 mb-1">Cuota 36 meses</div><div id="cuota36" class="text-xl font-bold">95,12 €</div></div>
        <div class="bg-white rounded-xl p-4 border"><div class="text-xs text-gray-600 mb-1">Importe restante (6m)</div><div id="restante6" class="text-xl font-bold">570,71 €</div></div>
        <div class="bg-white rounded-xl p-4 border"><div class="text-xs text-gray-600 mb-1">Financiación 6m (7,95% TAE)</div><div id="cuota6" class="text-xl font-bold">97,26 €</div></div>
      </div>
    </section>

    <!-- Modal editor -->
    <dialog id="dlg-edit" class="rounded-2xl p-0 w-full max-w-3xl">
      <form method="dialog" class="p-0 m-0">
        <div class="p-4 md:p-6 space-y-4">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold">Editar contenido</h3>
            <button class="px-3 py-1.5 rounded-lg border text-sm">Cerrar</button>
          </div>

          <label class="block text-sm text-gray-700">
            Características de gama
            <textarea id="txt-car" class="mt-1 w-full rounded-lg border-gray-300 px-3 py-2 h-40"
              placeholder="Ej.: Bluetooth LE, 16 canales, IP68, carga rápida, reducción de ruido…"></textarea>
          </label>

          <!-- Zona de imágenes -->
          <div class="space-y-2">
            <label class="text-sm text-gray-700">Imágenes (máx. 20)</label>
            <div id="drop-zone" class="drop-zone">Arrastra aquí tus imágenes o haz clic para seleccionarlas</div>
            <input id="file-add" type="file" accept="image/*" multiple class="hidden" />
            <div id="preview" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3"></div>
          </div>

          <div class="flex justify-end gap-2">
            <button id="btn-reload" type="button" class="px-3 py-2 rounded-lg border bg-white text-sm">Recargar</button>
            <button id="btn-save" type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white text-sm">Guardar</button>
          </div>

          <div id="msg" class="text-sm text-red-600"></div>
        </div>
      </form>
    </dialog>

    <!-- Modal PIN -->
    <dialog id="dlg-pin" class="rounded-2xl p-0 w-full max-w-xs">
      <form method="dialog" class="p-0 m-0">
        <div class="p-4 space-y-3">
          <h3 class="text-base font-semibold">Introduce PIN</h3>
          <input id="pin" type="password" inputmode="numeric" maxlength="8"
                 class="w-full rounded-lg border-gray-300 px-3 py-2 text-center tracking-widest"
                 placeholder="••••" />
          <div class="flex justify-end gap-2">
            <button class="px-3 py-2 rounded-lg border text-sm">Cancelar</button>
            <button id="btn-pin-ok" class="px-3 py-2 rounded-lg bg-red-600 text-white text-sm">Aceptar</button>
          </div>
          <div id="pin-msg" class="text-sm text-red-600"></div>
        </div>
      </form>
    </dialog>

  </main>

  <script>
    const GET_URL  = '/.netlify/functions/data-get';
    const SAVE_URL = '/.netlify/functions/data-save';
    const fmtMoneda = (n)=> n.toLocaleString('es-ES',{ minimumFractionDigits:2, maximumFractionDigits:2 })+' €';
    const mensualidad=(p,m,t)=>{const r=t/12;if(!r)return p/m;const pow=Math.pow(1+r,m);return p*(r*pow)/(pow-1);};
    let state={caracteristicasGama:'',imagenes:[]};
    let newImages=[];

    async function cargarDatos(){
      try{
        const r=await fetch(GET_URL,{cache:'no-store'});
        const d=await r.json();
        state={caracteristicasGama:d.caracteristicasGama||'',imagenes:Array.isArray(d.imagenes)?d.imagenes:[]};
        pintar();
      }catch(e){console.error(e);}
    }

    function pintar(){
      document.getElementById('caracteristicas').textContent=state.caracteristicasGama||'';
      const gal=document.getElementById('galeria');
      gal.innerHTML='';
      (state.imagenes||[]).forEach(u=>{
        const div=document.createElement('div');
        div.className='bg-white border rounded-xl p-3 flex items-center justify-center imgBox';
        const img=new Image(); img.src=u; img.className='object-cover h-full w-full rounded-lg';
        div.appendChild(img); gal.appendChild(div);
      });
      const amount=3995,principal=amount/42,rest=amount-(principal*36),cuota6=mensualidad(rest,6,0.0795);
      document.getElementById('importe').textContent=fmtMoneda(amount);
      document.getElementById('cuota36').textContent=fmtMoneda(principal);
      document.getElementById('restante6').textContent=fmtMoneda(rest);
      document.getElementById('cuota6').textContent=fmtMoneda(cuota6);
    }

    // === DRAG & DROP + PREVIEW ===
    const drop=document.getElementById('drop-zone');
    const fileInput=document.getElementById('file-add');
    const preview=document.getElementById('preview');

    drop.addEventListener('click',()=>fileInput.click());
    drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('dragover');});
    drop.addEventListener('dragleave',()=>drop.classList.remove('dragover'));
    drop.addEventListener('drop',e=>{
      e.preventDefault(); drop.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change',e=>handleFiles(e.target.files));

    function handleFiles(files){
      [...files].forEach(f=>{
        const r=new FileReader();
        r.onload=()=>{ newImages.push(r.result); renderPreview(); };
        r.readAsDataURL(f);
      });
    }
    function renderPreview(){
      preview.innerHTML='';
      newImages.forEach((u,i)=>{
        const card=document.createElement('div'); card.className='relative';
        const img=new Image(); img.src=u; img.className='rounded-xl object-cover w-full h-24';
        const del=document.createElement('button');
        del.textContent='❌';
        del.className='absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5 hover:bg-red-700';
        del.onclick=()=>{ newImages.splice(i,1); renderPreview(); };
        card.appendChild(img); card.appendChild(del); preview.appendChild(card);
      });
    }

    // === EDITOR ===
    document.getElementById('btn-edit').addEventListener('click',()=>{
      document.getElementById('txt-car').value=state.caracteristicasGama||'';
      newImages=[...state.imagenes]; renderPreview();
      document.getElementById('msg').textContent='';
      document.getElementById('dlg-edit').showModal();
    });

    // PIN modal
    async function pedirPin(){
      return new Promise(res=>{
        const dlg=document.getElementById('dlg-pin');
        const inp=document.getElementById('pin');
        const ok = ()=>{ dlg.close(); res(inp.value.trim()||null); };
        const cancel = ()=>{ dlg.close(); res(null); };
        document.getElementById('btn-pin-ok').onclick=ok;
        dlg.addEventListener('close',cancel,{once:true});
        inp.value=''; dlg.showModal();
      });
    }

    // Guardar
    document.getElementById('btn-save').addEventListener('click',async()=>{
      const car=document.getElementById('txt-car').value;
      const pin=await pedirPin(); if(!pin) return;
      const msg=document.getElementById('msg'); msg.textContent='Guardando…';
      try{
        const r=await fetch(SAVE_URL,{
          method:'POST', headers:{'content-type':'application/json'},
          body:JSON.stringify({ pin, payload:{ caracteristicasGama:car, imagenes:newImages.slice(0,20) }})
        });
        const d=await r.json();
        if(!r.ok){
          msg.textContent = d?.error==='PIN_INCORRECTO' ? 'PIN incorrecto' : 'No se pudo guardar';
          return;
        }
        state=d; pintar(); msg.textContent='Guardado ✓';
      }catch(e){ msg.textContent='Error guardando'; console.error(e); }
    });

    document.getElementById('btn-reload').addEventListener('click',cargarDatos);
    cargarDatos();
  <script>
/* ====== Auto-guardado local para tu editor ======
   - Guarda automáticamente al escribir.
   - Restaura al cargar la página.
   - Botones opcionales: #btnGuardar y #btnRecargar
   - Cambia NAMESPACE si quieres separar páginas/versiones.
*/
(function () {
  const NAMESPACE = "calculadora_infy_editor_v1";
  const KEY = `${NAMESPACE}:state`;

  // Util: ID estable para cada control
  function getStableId(el, idx) {
    return el.id || el.name || el.getAttribute("data-key") || el.placeholder || el.ariaLabel || `ctrl_${idx}`;
  }

  // Cargar estado
  function loadState() {
    try { return JSON.parse(localStorage.getItem(KEY) || "{}"); }
    catch { return {}; }
  }

  // Guardar estado
  function saveState(state) {
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  // Restaurar valores en la UI
  function restoreAll() {
    const saved = loadState();

    const controls = Array.from(document.querySelectorAll("input, textarea, select")); 
<<script>
(function () {
  const KEY = "calc_infy_content_v1";

  // Helpers
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const getBtnByText = (txt) =>
    $$("button, a, [role='button']").find(b => (b.textContent||"").trim().toLowerCase() === txt.toLowerCase());

  function loadState(){
    try { return JSON.parse(localStorage.getItem(KEY) || "{}"); }
    catch(e){ return {}; }
  }
  function saveState(state){
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  const state = loadState();

  // Inputs del modal
  // Ideal: <textarea data-field="caracteristicas"></textarea> y <textarea data-field="imagenes"></textarea>
  const modal = document.body; // usa el documento; si tienes un contenedor de modal, ponlo aquí
  const caracteristicas = $("[data-field='caracteristicas']") || $$("textarea, [contenteditable='true']").find(el => /características/i.test(el.closest("label,div,section,form")?.textContent||""));
  const imagenes = $("[data-field='imagenes']") || $$("textarea").find(el => /im[aá]genes/i.test(el.closest("label,div,section,form")?.textContent||""));

  // Botones
  const btnGuardar = $("[data-action='guardar']") || getBtnByText("Guardar");
  const btnRecargar = $("[data-action='recargar']") || getBtnByText("Recargar");

  // Rellenar desde storage
  if (caracteristicas && state.caracteristicas !== undefined) {
    if ("value" in caracteristicas) caracteristicas.value = state.caracteristicas;
    else caracteristicas.innerHTML = state.caracteristicas;
  }
  if (imagenes && state.imagenes !== undefined) {
    if ("value" in imagenes) imagenes.value = state.imagenes;
    else imagenes.textContent = state.imagenes;
  }

  // Auto-guardado al escribir
  const persist = () => {
    const s = loadState();
    if (caracteristicas) s.caracteristicas = ("value" in caracteristicas) ? caracteristicas.value : caracteristicas.innerHTML;
    if (imagenes) s.imagenes = ("value" in imagenes) ? imagenes.value : imagenes.textContent;
    saveState(s);
  };

  [caracteristicas, imagenes].filter(Boolean).forEach(el => {
    el.addEventListener("input", persist);
    el.addEventListener("change", persist);
  });

  // Guardar (confirma y refresca la vista fuera del modal)
  function applyToView(){
    // Ajusta estos selectores a tu UI real:
    // 1) Características visibles (ej. en la tabla “Ver características”)
    const contCaracteristicas = document.querySelector(".js-caracteristicas, [data-bind='caracteristicas']");
    if (contCaracteristicas && state.caracteristicas) {
      contCaracteristicas.innerHTML = state.caracteristicas
        .split(/\n+/).map(l => l.trim()).filter(Boolean).map(l => `<li>${l}</li>`).join("") || state.caracteristicas;
    }

    // 2) Galería de imágenes (una URL por línea)
    const contImagenes = document.querySelector(".js-galeria, [data-bind='imagenes']");
    if (contImagenes && state.imagenes) {
      const urls = state.imagenes.split(/\n+/).map(s => s.trim()).filter(Boolean);
      contImagenes.innerHTML = urls.map(u => `<img src="${u}" alt="" loading="lazy" style="max-width:120px;max-height:80px;margin:6px;border-radius:8px;border:1px solid #eee">`).join("");
    }
  }

  if (btnGuardar) {
    btnGuardar.addEventListener("click", (e) => {
      e.preventDefault();
      persist();
      // Feedback visual
      const n = document.createElement("div");
      n.textContent = "Guardado localmente ✅";
      Object.assign(n.style, {position:"fixed",right:"16px",bottom:"16px",padding:"10px 12px",background:"#16a34a",color:"#fff",borderRadius:"10px",fontSize:"14px",zIndex:9999});
      document.body.appendChild(n);
      setTimeout(()=>n.remove(), 1800);

      applyToView();
    });
  }

  if (btnRecargar) {
    btnRecargar.addEventListener("click", (e) => {
      e.preventDefault();
      const s = loadState();
      if (caracteristicas && s.caracteristicas !== undefined) {
        if ("value" in caracteristicas) caracteristicas.value = s.caracteristicas;
        else caracteristicas.innerHTML = s.caracteristicas;
      }
      if (imagenes && s.imagenes !== undefined) {
        if ("value" in imagenes) imagenes.value = s.imagenes;
        else imagenes.textContent = s.imagenes;
      }
    });
  }

  // Exportar/Importar (opcional): añade botones con data-action
  const btnExport = document.querySelector("[data-action='exportar-json']");
  const btnImport = document.querySelector("[data-action='importar-json']");

  if (btnExport) {
    btnExport.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(loadState(), null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "calculadora_infy_contenido.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });
  }

  if (btnImport) {
    btnImport.addEventListener("click", () => {
      const inp = document.createElement("input");
      inp.type = "file"; inp.accept = "application/json";
      inp.onchange = () => {
        const file = inp.files?.[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            saveState(data);
            location.reload();
          } catch(e){ alert("JSON inválido"); }
        };
        reader.readAsText(file);
      };
      inp.click();
    });
  }

  // Primera aplicación a la vista al cargar
  applyToView();
})();
</script>
/script>
</body>
</html>
