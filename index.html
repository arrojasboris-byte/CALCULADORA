<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CALCULADORA INFINITY AUDIO</title>
<style>
:root{
  --brand:#DC2626; --ink:#111827; --muted:#6B7280; --bg:#F6F7F9; --white:#fff;
  --card:#ffffff; --line:#E5E7EB;
}
html,body{background:var(--bg); color:var(--ink); margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
h1{margin:16px 0 0 0; font-size:42px; font-weight:900; letter-spacing:.5px;}
h1 small{display:block; font-size:14px; color:var(--muted); font-weight:700; margin-top:2px}
.wrapper{max-width:1100px;margin:0 auto;padding:16px 16px 40px}
.paper{background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); margin:12px 0; overflow:hidden}
.hd{padding:10px 14px; font-weight:800; color:#fff; background:var(--brand)}
.hd.ribbon{position:relative}
.bd{padding:14px}
.grid{display:grid;gap:12px}
.g-cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
.g-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.g-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}
.card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;min-height:120px}
.tab{display:flex;gap:8px}
.tab .btn{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:14px;font-size:13px;cursor:pointer}
.tab .btn.sel{outline:2px solid var(--brand)}
.tab .btn small{color:var(--muted)}
.pr{font-weight:800}
.area{width:100%;min-height:140px;border:1px solid var(--line);border-radius:12px;padding:10px;resize:vertical}
.area[readonly]{background:#FAFAFA}
.note{color:var(--muted);font-size:12px;margin-top:8px}
.kpis{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr;gap:10px}
.kpis .box{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
.kpis .big{font-size:36px;font-weight:900;color:var(--brand)}
.kpis .mut{color:var(--muted);font-size:12px;margin-top:4px}
.kpis .gray{background:#F8FAFC}
.kpis .bign{font-size:32px;font-weight:900}
.rows{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.b{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
.b.red{background:var(--brand);color:#fff;border-color:var(--brand)}
.b.ghost{background:#fff}
.badge{display:inline-block;border-radius:999px;padding:4px 8px;border:1px solid var(--line);font-size:12px}
#upBox{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
.pill{border-radius:12px;background:#fff;border:1px solid var(--line);padding:12px 14px;text-align:center;cursor:pointer;font-weight:800}
.pill.red{background:var(--brand);color:#fff;border-color:var(--brand)}
.pill.dim{background:#E5E7EB;color:#6B7280;cursor:not-allowed}
.pill.sel{outline:2px solid var(--brand)}
hr.sep{border:0;height:1px;background:var(--line);margin:12px 0}
.top-actions{display:flex;gap:8px;align-items:center}
@media (max-width:980px){
  .kpis{grid-template-columns:1fr 1fr}
  #upBox{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
  <div class="wrapper">
    <h1>CALCULADORA INFINITY <small>AUDIO · 36 MESES 0% TAE + 6 MESES 7,95% TAE</small></h1>

    <!-- FORMATOS -->
    <section class="paper">
      <div class="hd ribbon">
        <div class="top-actions" style="justify-content:space-between">
          <span>Formatos de audífonos</span>
          <div>
            <button id="btnEdit" class="b red">Editar</button>
            <button id="btnSave" class="b" style="display:none">Guardar</button>
          </div>
        </div>
      </div>
      <div class="bd">
        <div class="grid g-cols-4">
          <div class="card">RIC / RIC Premium</div>
          <div class="card">BTE</div>
          <div class="card">Intracanal estándar</div>
          <div class="card">Intracanal a medida</div>
        </div>
      </div>
    </section>

    <!-- GAMAS + CARACTERÍSTICAS -->
    <section class="paper">
      <div class="hd ribbon">Características y gamas</div>
      <div class="bd">
        <div class="grid g-cols-2">
          <div><div id="gamas" class="tab"></div></div>
          <div>
            <div style="font-weight:800;margin:4px 0 6px">Características – <span id="carTitle"></span></div>
            <textarea id="txtCar" class="area" readonly placeholder="Escribe aquí las características (una por línea)…"></textarea>
            <div class="note">Para editar las características introduce el PIN en “Editar”.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- FINANCIACIÓN -->
    <section class="paper">
      <div class="hd ribbon">Financiación Infinity + tchin tchin</div>
      <div class="bd">
        <div class="kpis">
          <div class="box gray">
            <div class="mut">Importe total</div>
            <div id="impBase" class="bign">—</div>
          </div>
          <div class="box">
            <div class="mut">Cuota 36m (0%)</div>
            <div class="big"><span id="c36">—</span></div>
            <div class="mut" id="c36det">—</div>
          </div>
          <div class="box">
            <div class="mut">RESTANTE 6M-AHORRO SI RENUEVAS</div>
            <div class="bign" id="res6">—</div>
          </div>
          <div class="box">
            <div class="mut">Cuota 6m (7,95% TAE)</div>
            <div class="bign" id="c6">—</div>
          </div>
        </div>

        <div class="rows">
          <div class="box gray">
            <div class="mut">Importe con 2º pareja</div>
            <div id="impUp" class="bign">—</div>
          </div>
          <div class="box">
            <div class="mut">Cuota 36m (0%)</div>
            <div class="big"><span id="c36u">—</span></div>
            <div class="mut" id="c36udet">—</div>
          </div>
          <div class="box">
            <div class="mut">RESTANTE 6M-AHORRO SI RENUEVAS</div>
            <div class="bign" id="res6u">—</div>
          </div>
          <div class="box">
            <div class="mut">Cuota 6m (7,95% TAE)</div>
            <div class="bign" id="c6u">—</div>
          </div>
        </div>

        <div class="btns" style="margin-top:12px">
          <button id="btnPDF" class="b">Guardar PDF</button>
          <button id="btnHtml" class="b">Descargar HTML con datos (solo lectura)</button>
        </div>
      </div>
    </section>

    <!-- COMPROMISOS -->
    <section class="paper">
      <div class="hd ribbon">COMPROMISOS</div>
      <div class="bd">
        <details id="compWrap" open>
          <summary style="cursor:pointer;font-weight:800;color:#374151;margin-bottom:8px">Mostrar / ocultar</summary>
          <textarea id="txtComp" class="area" readonly placeholder="Escribe aquí los compromisos (se guardan en este archivo)."></textarea>
          <div class="note">Editable con PIN (botón “Editar”). Si no lo despliegas, se guarda igualmente el valor por defecto.</div>
        </details>
      </div>
    </section>

    <!-- COMPROMISOS AAA (nuevo, plegado por defecto) -->
    <section class="paper">
      <div class="hd ribbon">COMPROMISOS AAA</div>
      <div class="bd">
        <details id="compWrap2">
          <summary style="cursor:pointer;font-weight:800;color:#374151;margin-bottom:8px">Mostrar / ocultar</summary>
          <textarea id="txtComp2" class="area" readonly placeholder="Escribe aquí los compromisos AAA (se guardan en este archivo)."></textarea>
          <div class="note">Editable con PIN (botón “Editar”). Aunque quede plegado, su contenido se guarda por defecto.</div>
        </details>
      </div>
    </section>

    <!-- UPGRADE -->
    <section class="paper">
      <div class="hd ribbon">2º PAREJA RECOMENDADA</div>
      <div class="bd">
        <div id="upBox"></div>
        <div class="note" style="margin-top:8px">Se muestra en rojo la recomendada (Diamante Plus); las superiores se deshabilitan.</div>
      </div>
    </section>

  </div>

<!-- PIN dialog nativo -->
<dialog id="dlg">
  <form method="dialog" style="min-width:280px">
    <h3 style="margin:0 0 8px;font-weight:900">Introduce PIN</h3>
    <input id="pin" type="password" inputmode="numeric" maxlength="8" placeholder="••••"
           style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px"/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="b">Cancelar</button>
      <button id="okPin" class="b red">Aceptar</button>
    </div>
    <div id="pinMsg" class="note" style="color:#DC2626"></div>
  </form>
</dialog>

<script>
/* === Datos base === */
const GAMAS=[
  {id:"diamantePlus",  nombre:"Diamante Plus", precio:3995, upgNombre:"Diamante Plus (+2004€)", upgImporte:2004},
  {id:"diamante",      nombre:"Diamante",      precio:3895, upgNombre:"Diamante (+1904€)",     upgImporte:1904},
  {id:"platinoPlus",   nombre:"Platino Plus",  precio:3395, upgNombre:"Platino Plus (+1404€)", upgImporte:1404},
  {id:"platino",       nombre:"Platino",       precio:3295, upgNombre:"Platino (+1304€)",      upgImporte:1304},
  {id:"oro",           nombre:"Oro",           precio:1991, upgNombre:"", upgImporte:0},
];

/* === Estado y helpers === */
const $=sel=>document.querySelector(sel);
const fmt=(n)=>n.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2})+' €';
const mensualidad=(p,m,t)=>{const r=t/12;if(!r)return p/m;const pow=Math.pow(1+r,m);return p*(r*pow)/(pow-1);};

const DEFAULT={
  gamaId:"diamantePlus",
  caracteristicas:"• Gran rendimiento\n• 14 canales\n• Control inteligencia ambiental",
  imagenes:[],
  compromisos:"• Revisiones trimestrales\n• Mantenimiento preventivo\n• Sustitución de filtros incluida",
  compromisosAAA:"• Compromiso AAA 1\n• Compromiso AAA 2"
};

/* Cargamos estado y fijamos SIEMPRE la recomendada a Diamante Plus */
let state = window.__EMBEDDED_STATE ? {...DEFAULT,...window.__EMBEDDED_STATE}: DEFAULT;
if(state.upgradeFixedId===undefined){ state.upgradeFixedId = "diamantePlus"; }  // SIEMPRE Diamante Plus
if(state.upgradeChosenId===undefined){ state.upgradeChosenId = null; }
if(state.upgradeActivo===undefined){ state.upgradeActivo = true; }

function gamaById(id){ return GAMAS.find(g=>g.id===id); }

/* === Render de gamas (sin tocar cálculo recomendado fijo) === */
function renderGamas(){
  const box=$("#gamas"); box.innerHTML="";
  GAMAS.forEach(g=>{
    if(g.id==="oro") return;
    const btn=document.createElement("div");
    btn.className="btn"+(state.gamaId===g.id?" sel":"");
    btn.innerHTML=`<span>${g.nombre}</span><span class="pr">${fmt(g.precio)}</span>`;
    btn.onclick=()=>{
      state.gamaId=g.id;
      // La recomendada se mantiene SIEMPRE en Diamante Plus; no se cambia aquí.
      // Si hay una elección temporal y dejara de ser inferior, se anula.
      if(state.upgradeChosenId){
        const idxSel=GAMAS.findIndex(gg=>gg.id===state.gamaId);
        const idxChosen=GAMAS.findIndex(gg=>gg.id===state.upgradeChosenId);
        if(idxChosen<idxSel) state.upgradeChosenId=null;
      }
      save(); renderGamas(); renderUpgrades(); fillSide(); calc();
    };
    box.appendChild(btn);
  });
  $("#carTitle").textContent=gamaById(state.gamaId).nombre;
}

/* === Upgrades: Diamante Plus SIEMPRE rojo y fijo; inferiores opcionales === */
function renderUpgrades(){
  const box=$("#upBox"); box.innerHTML="";
  const idxSel=GAMAS.findIndex(g=>g.id===state.gamaId);
  GAMAS.filter(g=>g.id!=="oro").forEach(g=>{
    const idxG=GAMAS.findIndex(gg=>gg.id===g.id);
    const superior = idxG < idxSel;
    const isFixed = g.id==="diamantePlus";              // fija en Diamante Plus SIEMPRE
    const isChosen = state.upgradeChosenId===g.id;
    const pill=document.createElement("div");
    pill.className="pill "+(isFixed?"red":(superior?"dim":(isChosen?"sel":"")));
    pill.textContent=g.upgNombre || g.nombre;
    pill.onclick=()=>{
      if(isFixed){
        // Recomendado fijo: volver al valor original siempre (no varía)
        state.upgradeChosenId=null;
      }else{
        if(superior) return; // superiores deshabilitadas
        state.upgradeChosenId = (state.upgradeChosenId===g.id ? null : g.id);
      }
      state.upgradeActivo=true;
      save(); renderUpgrades(); calc();
    };
    box.appendChild(pill);
  });
}

/* === Side (características y compromisos) === */
function fillSide(){
  $("#txtCar").value = state.caracteristicas||"";
  $("#txtComp").value= state.compromisos||"";
  $("#txtComp2").value= state.compromisosAAA||"";
}

/* === Cálculos === */
function calc(){
  const g=gamaById(state.gamaId);
  const base=g.precio;

  const c36=base/42;
  const rest=base - c36*36;
  const c6 = mensualidad(rest,6,0.0795);

  $("#impBase").textContent=fmt(base);
  $("#c36").textContent=fmt(c36);
  $("#c36det").textContent=`${fmt(base)} / 42`;
  $("#res6").textContent=fmt(rest);
  $("#c6").textContent=fmt(c6);

  // Segunda operación: usa elección temporal si existe; si no, SIEMPRE Diamante Plus
  const upId = state.upgradeChosenId || "diamantePlus";
  const ug=gamaById(upId);
  const up = ug ? (ug.upgImporte||0) : 0;
  const tot = base + up;

  const c36u=tot/42;
  const restu=tot - c36u*36;
  const c6u=mensualidad(restu,6,0.0795);

  $("#impUp").textContent=fmt(tot);
  $("#c36u").textContent=fmt(c36u);
  $("#c36udet").textContent=`${fmt(tot)} / 42`;
  $("#res6u").textContent=fmt(restu);
  $("#c6u").textContent=fmt(c6u);
}

/* === Export === */
$("#btnPDF").onclick=()=>window.print();
function exportHTML(){
  const html=document.documentElement.outerHTML
    .replace("</head>","<script>window.__EMBEDDED_STATE="+JSON.stringify(state)+"</script></head>");
  const blob=new Blob([html],{type:"text/html"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="calculadora_infinity_audio.html";
  a.click();
  URL.revokeObjectURL(a.href);
}
$("#btnHtml").onclick=exportHTML;

/* === PIN / Edición === */
let pinOk=false;
function toggleEditUI(){
  const on=pinOk;
  $("#btnEdit").style.display=on?"none":"inline-block";
  $("#btnSave").style.display=on?"inline-block":"none";
  $("#txtCar").readOnly=!on;
  $("#txtComp").readOnly=!on;
  $("#txtComp2").readOnly=!on;
}
$("#btnEdit").onclick=()=>{
  const dlg=$("#dlg"), pin=$("#pin"), msg=$("#pinMsg");
  msg.textContent=""; pin.value="";
  dlg.showModal();
  $("#okPin").onclick=(ev)=>{
    ev.preventDefault();
    if(pin.value.trim()==="4321"){
      pinOk=true; toggleEditUI(); dlg.close();
    }else{
      msg.textContent="PIN incorrecto";
    }
  };
};
$("#btnSave").onclick=()=>{
  save();
  pinOk=false; toggleEditUI();
  alert("Guardado ✅");
};

/* === Persistencia === */
function save(){
  if(pinOk){
    state.caracteristicas = $("#txtCar").value;
    state.compromisos   = $("#txtComp").value;
    state.compromisosAAA= $("#txtComp2").value;
  }
  localStorage.setItem("calc_infy_state", JSON.stringify(state));
}
(function boot(){
  try{
    const s=JSON.parse(localStorage.getItem("calc_infy_state")||"{}");
    state={...DEFAULT,...s};
  }catch{}
  // Asegura recomendada fija en Diamante Plus SIEMPRE
  state.upgradeFixedId="diamantePlus";
  renderGamas(); renderUpgrades(); fillSide(); calc(); toggleEditUI();
})();
</script>
</body>
</html>
