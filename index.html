<!-- ===================== COMPROMISOS (DESPUÉS DE 2º PAREJA) ===================== -->
<style>
  /* Forzamos faldón rojo y mismo “skin” del resto de secciones */
  #compromisos-block .hd{
    background:#dc2626 !important;
    color:#fff !important;
    padding:10px 14px !important;
    font-weight:700 !important;
    border-top-left-radius:12px !important;
    border-top-right-radius:12px !important;
  }
  #compromisos-block .bd{
    background:#fff !important;
    padding:12px 14px !important;
    border-bottom-left-radius:12px !important;
    border-bottom-right-radius:12px !important;
  }
  #compromisos-block details>summary{
    cursor:pointer; list-style:none;
    margin-bottom:8px; font-weight:600;
  }
  #compromisos-block details>summary::-webkit-details-marker{ display:none; }
  #compromisos-block .area{
    width:100%; min-height:220px; resize:vertical;
    border:1px solid #e5e7eb; border-radius:10px; padding:10px;
    font-family:inherit; font-size:14px;
    background:#fff;
  }
  #compromisos-block .note{ font-size:12px; color:#6b7280; margin-top:6px; }
</style>

<section class="paper" id="compromisos-block">
  <div class="hd">COMPROMISOS</div>
  <div class="bd">
    <details id="compWrap" open>
      <summary>Mostrar / ocultar</summary>
      <textarea id="txtComp_calc_infy" class="area" readonly
        placeholder="Escribe aquí los compromisos…"></textarea>
      <div class="note">Editable con PIN (usa el botón “Editar”).</div>
    </details>
  </div>
</section>

<script>
/* Glue: integra COMPROMISOS con tu flujo de PIN/Guardar sin tocar el resto */
(function(){
  const LS_KEY = 'calc_infy_state';
  const el = document.getElementById('txtComp_calc_infy');
  if(!el) return;

  function getState(){
    try{ if (window.state && typeof window.state==='object') return window.state; }catch(e){}
    try{ const raw = localStorage.getItem(LS_KEY); if (raw) return JSON.parse(raw); }catch(e){}
    return {};
  }
  function setState(s){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(s)); }catch(e){}
  }

  // Inicializa
  const st = getState();
  if (typeof st.compromisos === 'string'){
    el.value = st.compromisos;
  } else {
    // Texto por defecto EN DOS LÍNEAS (sin \n literal en pantalla)
    el.value = '• Compromiso 1\n• Compromiso 2';
  }

  // Respeta el modo edición/solo lectura (PIN 4321)
  function applyReadOnly(){
    const can = (typeof window.pinOk !== 'undefined') ? !!window.pinOk : false;
    el.readOnly = !can;
  }
  applyReadOnly();

  // Hook al botón Editar para alternar readonly según tu toggleEditUI
  if (typeof window.toggleEditUI === 'function'){
    const _orig = window.toggleEditUI;
    window.toggleEditUI = function(){
      let r; try{ r = _orig.apply(this, arguments); }catch(e){}
      applyReadOnly(); return r;
    };
  }

  // Persistencia al Guardar (se une a tu save existente)
  function persist(){
    const s = getState();
    // Solo sobreescribe si estás en edición; en lectura respeta lo guardado
    if (!el.readOnly) s.compromisos = el.value;
    else if (typeof s.compromisos === 'undefined') s.compromisos = el.value;
    setState(s);
  }

  if (typeof window.save === 'function'){
    const _save = window.save;
    window.save = function(){
      let r; try{ r = _save.apply(this, arguments); }catch(e){}
      persist(); return r;
    };
  } else {
    const btn = document.getElementById('btnSave') || document.querySelector('[data-action="guardar"]');
    if (btn) btn.addEventListener('click', persist);
  }

  // Pequeña seguridad extra si editas y sales
  el.addEventListener('change', ()=>{ if(!el.readOnly) persist(); });
})();
</script>
<!-- =================== /COMPROMISOS =================== -->
