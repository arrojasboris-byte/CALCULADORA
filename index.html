<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrador de Catálogo — Calculadora Infinity Audio</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --line:#e5e7eb; --muted:#667085; --brand:#d72638; --ok:#027a48; --err:#b42318; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"; background: var(--bg); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    .card { background: var(--card); border-radius: 18px; padding: 20px; box-shadow: 0 6px 24px rgba(0,0,0,.06); }
    h1 { margin: 0 0 2px; font-size: 26px; letter-spacing: .2px; }
    .muted { color: var(--muted); margin: 0 0 16px; }
    label { font-weight: 600; display: block; margin: 14px 0 6px; }
    textarea, input[type="text"], input[type="password"] { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #d0d5dd; background: #fafafa; font-size: 14px; }
    textarea { min-height: 160px; resize: vertical; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .btn { appearance: none; border: 0; border-radius: 12px; padding: 10px 14px; font-weight: 700; cursor: pointer; }
    .btn-ghost { background: transparent; color: var(--brand); border: 1px solid var(--brand); }
    .btn-primary { background: var(--brand); color: #fff; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .bar { display:flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 14px; }
    .status { font-size: 12px; color: var(--muted); }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap: 12px; }
    .imgbox { background:#f2f4f7; border:1px dashed #d0d5dd; border-radius: 12px; min-height: 120px; display:grid; place-items:center; overflow:hidden; }
    .imgbox img { width:100%; height:100%; object-fit:cover; }
    .help { font-size: 12px; color: var(--muted); }
    hr { border: 0; border-top: 1px solid var(--line); margin: 18px 0; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background: #eef2ff; border:1px solid #c7d2fe; padding: 0 6px; border-radius: 6px; }
    .pill { display:inline-block; padding: 2px 10px; border-radius: 999px; background:#eef2ff; color:#222; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Administrador de Catálogo</h1>
      <p class="muted">Edita <strong>Características de gama</strong> e <strong>Imágenes</strong>. Necesitas PIN.</p>

      <div class="row">
        <div style="flex:1; min-width: 220px">
          <label for="pin">PIN</label>
          <input id="pin" type="password" inputmode="numeric" placeholder="4321" autocomplete="off" />
          <p class="help">El PIN se valida en el servidor. Cámbialo en la variable <span class="kbd">ADMIN_PIN</span> de Netlify.</p>
        </div>
        <div class="bar" style="flex:1; min-width: 220px">
          <span id="status" class="status">Cargando…</span>
          <div class="row" style="justify-content:flex-end">
            <button id="recargar" class="btn btn-ghost">Recargar</button>
            <button id="guardar" class="btn btn-primary">Guardar</button>
          </div>
        </div>
      </div>

      <label for="caracteristicas">Características de gama</label>
      <textarea id="caracteristicas" placeholder="Ej.: Bluetooth LE, 16 canales, IP68, carga rápida, reducción de ruido…"></textarea>

      <label for="imagenes">Imágenes (URLs públicas, una por línea)</label>
      <textarea id="imagenes" placeholder="https://...&#10;https://..."></textarea>
      <p class="help">Se mostrarán en la galería. Máx. 20. Usa imágenes ya alojadas (CDN/Drive público/etc.).</p>

      <hr />

      <div class="bar">
        <div>
          <strong>Vista previa</strong>
          <span id="lastUpdate" class="pill" style="margin-left:8px">—</span>
        </div>
        <div class="row">
          <a class="btn btn-ghost" href="/" target="_blank" rel="noopener">Ver web</a>
        </div>
      </div>

      <div id="galeria" class="grid" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
    const byId = (id) => document.getElementById(id);
    const $status = byId('status');
    const $last = byId('lastUpdate');
    const $car = byId('caracteristicas');
    const $imgs = byId('imagenes');
    const $gal = byId('galeria');
    const $pin = byId('pin');

    const GET_URL = '/.netlify/functions/data-get';
    const SAVE_URL = '/.netlify/functions/data-save';

    async function cargar() {
      setStatus('Cargando…');
      try {
        const res = await fetch(GET_URL, { cache: 'no-store' });
        if (!res.ok) {
          if (res.status === 404) {
            setStatus('No se encuentra la Function data-get (404). Revisa netlify/functions y netlify.toml.', true);
          } else {
            setStatus('Error cargando datos (' + res.status + ')', true);
          }
          return;
        }
        const data = await res.json();
        $car.value = data.caracteristicasGama || '';
        $imgs.value = (data.imagenes || []).join('\n');
        $last.textContent = data.updatedAt
          ? new Date(data.updatedAt).toLocaleString()
          : '—';
        renderGaleria(data.imagenes || []);
        setStatus('Listo ✓', false);
      } catch (e) {
        setStatus('Fallo de red al cargar datos', true);
        console.error(e);
      }
    }

    function renderGaleria(urls) {
      $gal.innerHTML = '';
      (urls || []).forEach(u => {
        const box = document.createElement('div');
        box.className = 'imgbox';
        if (u) {
          const img = new Image();
          img.src = u;
          img.loading = 'lazy';
          img.alt = 'Imagen de la gama';
          box.appendChild(img);
        } else {
          box.textContent = 'Sin imagen';
        }
        $gal.appendChild(box);
      });
    }

    async function guardar() {
      const pin = ($pin.value || '').trim();
      if (!pin) {
        setStatus('Introduce el PIN', true);
        $pin.focus();
        return;
      }
      const payload = {
        caracteristicasGama: $car.value || '',
        imagenes: ($imgs.value || '')
          .split('\n')
          .map(s => s.trim())
          .filter(Boolean)
          .slice(0, 20)
      };

      setStatus('Guardando…');
      try {
        const res = await fetch(SAVE_URL, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ pin, payload })
        });
        const data = await res.json().catch(()=>null);

        if (!res.ok) {
          if (res.status === 401) {
            setStatus('PIN incorrecto', true);
          } else if (res.status === 404) {
            setStatus('No se encuentra la Function data-save (404). Revisa netlify/functions.', true);
          } else {
            setStatus('Error al guardar (' + res.status + ')', true);
          }
          return;
        }

        // Éxito
        $car.value = data?.caracteristicasGama || payload.caracteristicasGama;
        $imgs.value = (data?.imagenes || payload.imagenes).join('\n');
        renderGaleria(data?.imagenes || payload.imagenes);
        $last.textContent = data?.updatedAt
          ? new Date(data.updatedAt).toLocaleString()
          : new Date().toLocaleString();
        setStatus('Cambios guardados ✓', false);
      } catch (e) {
        setStatus('Fallo de red al guardar', true);
        console.error(e);
      }
    }

    function setStatus(text, isError) {
      $status.textContent = text;
      $status.className = 'status' + (isError ? ' err' : ' ok');
    }

    byId('guardar').addEventListener('click', guardar);
    byId('recargar').addEventListener('click', cargar);

    // Carga inicial
    cargar();
  </script>
</body>
</html>
