<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Visor datos Calculadora Infinity</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7f9;margin:0;padding:24px;color:#111}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:20px;max-width:1000px;margin:0 auto}
  h1{margin:0 0 12px;font-size:20px}
  .muted{color:#6b7280;font-size:13px}
  textarea{width:100%;min-height:160px;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font:inherit;background:#fff}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .thumb{border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;width:160px;height:120px;display:flex;align-items:center;justify-content:center;background:#fff}
  .thumb img{max-width:100%;max-height:100%;display:block}
  .actions{display:flex;gap:8px;margin-top:12px}
  button{padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#111;color:#fff;cursor:pointer}
  button.secondary{background:#fff;color:#111}
  code{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
  <div class="card">
    <h1>Visor datos — Calculadora Infinity</h1>
    <div class="muted">Lee el contenido guardado en tu nube (Drive vía Apps Script). No requiere PIN.</div>

    <div style="margin-top:10px">
      <div class="muted">WEB_APP_URL actual:</div>
      <code id="url"></code>
    </div>

    <div class="actions">
      <button id="btn-cargar">Cargar</button>
      <button id="btn-descargar" class="secondary" disabled>Descargar JSON</button>
      <button id="btn-copiar" class="secondary" disabled>Copiar JSON</button>
    </div>

    <h2 style="margin-top:18px;font-size:16px">Características</h2>
    <textarea id="txt" readonly placeholder="(vacío)"></textarea>

    <h2 style="margin-top:18px;font-size:16px">Imágenes</h2>
    <div id="imgs" class="row"></div>

    <div class="muted" style="margin-top:12px">Actualizado: <span id="ts">—</span></div>
  </div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzFxez1KdhM34wU9xhpk_otJuAzXl6e98QNfaJB_P_73VCyM9ufjA-T8vYvlEL9nAvE/exec";
document.getElementById('url').textContent = WEB_APP_URL;

let lastData = null;

async function cargar(){
  const btn = document.getElementById('btn-cargar');
  btn.disabled = true; btn.textContent = 'Cargando…';
  try{
    const r = await fetch(WEB_APP_URL, { cache:'no-store' });
    const d = await r.json();
    lastData = d;

    // Características
    document.getElementById('txt').value = d?.caracteristicasGama || '';

    // Imágenes
    const cont = document.getElementById('imgs');
    cont.innerHTML = '';
    (Array.isArray(d?.imagenes) ? d.imagenes : []).forEach(u=>{
      const wrap = document.createElement('a');
      wrap.href = u; wrap.target = '_blank'; wrap.rel='noopener';
      wrap.className = 'thumb';
      const img = new Image(); img.src = u; img.loading='lazy';
      wrap.appendChild(img); cont.appendChild(wrap);
    });

    // Timestamp
    const ts = d?.updated_at ? new Date(d.updated_at) : null;
    document.getElementById('ts').textContent = ts ? ts.toLocaleString('es-ES') : '—';

    // Acciones
    document.getElementById('btn-descargar').disabled = false;
    document.getElementById('btn-copiar').disabled = false;
  }catch(e){
    alert('No se pudo cargar: ' + e);
  }finally{
    btn.disabled = false; btn.textContent = 'Cargar';
  }
}

function descargar(){
  if(!lastData){ return; }
  const blob = new Blob([JSON.stringify(lastData, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'calculadora_infy_datos.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

async function copiar(){
  if(!lastData){ return; }
  try{
    await navigator.clipboard.writeText(JSON.stringify(lastData, null, 2));
    alert('JSON copiado al portapapeles.');
  }catch{
    alert('No se pudo copiar. Descarga el JSON y abrelo con un editor.');
  }
}

document.getElementById('btn-cargar').addEventListener('click', cargar);
document.getElementById('btn-descargar').addEventListener('click', descargar);
document.getElementById('btn-copiar').addEventListener('click', copiar);

// Carga directa al abrir
cargar();
</script>
</body>
</html>
