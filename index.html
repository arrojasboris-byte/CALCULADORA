<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CALCULADORA INFINITY AUDIO</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{background:#f7f7f8;font-family:sans-serif;}
    .card{background:#fff;border-radius:1rem;box-shadow:0 4px 20px rgba(0,0,0,0.08);padding:1rem;margin-bottom:1rem;}
    .imgbox{aspect-ratio:1/1;overflow:hidden;border-radius:1rem;background:#fafafa;}
    .imgbox img{object-fit:cover;width:100%;height:100%;}
    .btn{background:#d10000;color:#fff;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;}
    .btn:hover{background:#b00000;}
    textarea{width:100%;border:1px solid #ccc;border-radius:.5rem;padding:.5rem;}
  </style>
</head>

<body class="p-4 max-w-5xl mx-auto space-y-6">
  <h1 class="text-4xl font-bold text-red-700 text-center">CALCULADORA INFINITY AUDIO</h1>

  <section class="card">
    <h2 class="font-semibold mb-2">Características de gama</h2>
    <textarea id="caracteristicas" rows="6"></textarea>
  </section>

  <section class="card">
    <h2 class="font-semibold mb-2">Imágenes</h2>
    <input type="file" id="imgUpload" accept="image/*" multiple>
    <div id="galeria" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 mt-3"></div>
  </section>

  <section class="card">
    <h2 class="font-semibold mb-2">Gamas</h2>
    <div id="gamas"></div>
  </section>

  <section class="card">
    <h2 class="font-semibold mb-2">Upgrade recomendado</h2>
    <div id="upgrades" class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3"></div>
  </section>

  <section class="card">
    <h2 class="font-semibold mb-2">Financiación</h2>
    <div id="financiacion" class="space-y-1 text-sm"></div>
  </section>

  <div class="flex justify-end gap-3">
    <button class="btn" id="btnGuardar">💾 Guardar</button>
    <button class="btn" style="background:#555" id="btnCargar">🔄 Cargar</button>
  </div>

  <script>
    /* === CONFIG === */
    const WEB_APP_URL = "https://script.google.com/macros/s/XXXXXXXXXXXX/exec"; // <-- cambia esto
    const PIN = "4321";

    const gamas = [
      { nombre:"Diamante Plus", precio:3995 },
      { nombre:"Diamante", precio:3091 },
      { nombre:"Platino Plus", precio:2551 },
      { nombre:"Platino", precio:1901 },
    ];
    const upgrades = [
      { nombre:"Upgrade Diamante Plus +2004 €", importe:2004, recomendado:true },
      { nombre:"Upgrade Diamante +1904 €", importe:1904 },
      { nombre:"Upgrade Platino Plus +1404 €", importe:1404 },
      { nombre:"Upgrade Platino +1294 €", importe:1294 },
    ];

    let state = { caracteristicas:"", imagenes:[], gamaIndex:0, upgradeIndex:0 };

    /* === Render === */
    const galeria = document.getElementById("galeria");
    const gamaDiv = document.getElementById("gamas");
    const upgDiv = document.getElementById("upgrades");
    const fin = document.getElementById("financiacion");

    function renderGamas(){
      gamaDiv.innerHTML = "";
      gamas.forEach((g,i)=>{
        const btn=document.createElement("button");
        btn.textContent=`${g.nombre} (${g.precio} €)`;
        btn.className=`px-3 py-2 rounded-lg border text-sm ${state.gamaIndex===i?"bg-red-600 text-white":"bg-white"}`;
        btn.onclick=()=>{state.gamaIndex=i;calcular();renderGamas();};
        gamaDiv.appendChild(btn);
      });
    }

    function renderUpgrades(){
      upgDiv.innerHTML="";
      upgrades.forEach((u,i)=>{
        const card=document.createElement("button");
        card.className=`rounded-xl border p-4 text-left hover:shadow transition text-sm ${state.upgradeIndex===i?"border-red-600 bg-red-50":""}`;
        card.innerHTML=`<div class="font-semibold">${u.nombre}</div><div class="text-gray-600 mt-1">${u.importe} €</div>`;
        card.onclick=()=>{state.upgradeIndex=i;calcular();renderUpgrades();};
        upgDiv.appendChild(card);
      });
    }

    function renderImgs(){
      galeria.innerHTML="";
      state.imagenes.forEach((src,idx)=>{
        const box=document.createElement("div");
        box.className="imgbox";
        const img=document.createElement("img");
        img.src=src;
        const del=document.createElement("button");
        del.textContent="×";
        del.className="absolute bg-red-600 text-white rounded-full px-2 text-xs";
        del.onclick=()=>{state.imagenes.splice(idx,1);renderImgs();};
        box.appendChild(img);
        galeria.appendChild(box);
      });
    }

    function calcular(){
      const gama=gamas[state.gamaIndex];
      const up=upgrades[state.upgradeIndex];
      const total=gama.precio+up.importe;
      const cuota36=total/42;
      const restante=total-cuota36*36;
      const r=0.0795/12;
      const cuota6=restante*(r*Math.pow(1+r,6))/(Math.pow(1+r,6)-1);
      fin.innerHTML=`
        <div>Total: ${total.toFixed(2)} €</div>
        <div>36 meses: ${cuota36.toFixed(2)} €/mes</div>
        <div>Restante: ${restante.toFixed(2)} €</div>
        <div>6 meses al 7,95% TAE: ${cuota6.toFixed(2)} €/mes</div>
      `;
    }

    /* === Guardar/Cargar en la nube === */
    async function guardar(){
      const data={
        caracteristicas:document.getElementById("caracteristicas").value,
        imagenes:state.imagenes,
        gamaIndex:state.gamaIndex,
        upgradeIndex:state.upgradeIndex
      };
      const res=await fetch(WEB_APP_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({pin:PIN,data})
      });
      const r=await res.json();
      alert(r.ok?"✅ Guardado":"❌ Error: "+r.error);
    }

    async function cargar(){
      const res=await fetch(WEB_APP_URL);
      const data=await res.json();
      if(!data.caracteristicas)return alert("No hay datos guardados aún");
      state=data;
      document.getElementById("caracteristicas").value=data.caracteristicas;
      renderImgs(); renderGamas(); renderUpgrades(); calcular();
      alert("✅ Cargado correctamente");
    }

    /* === Imágenes locales === */
    document.getElementById("imgUpload").addEventListener("change",e=>{
      [...e.target.files].forEach(f=>{
        const r=new FileReader();
        r.onload=()=>{state.imagenes.push(r.result);renderImgs();};
        r.readAsDataURL(f);
      });
    });

    document.getElementById("btnGuardar").onclick=guardar;
    document.getElementById("btnCargar").onclick=cargar;

    renderGamas(); renderUpgrades(); calcular();
  </script>
</body>
</html>
