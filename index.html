<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CALCULADORA INFINITY AUDIO</title>
  <meta name="color-scheme" content="light" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme:{ extend:{ colors:{ brand:{ red:'#DC2626', gray:'#6B7280' }}}}}
  </script>
  <style>
    html, body { background:#f6f7f9; }
    .paper { background:white; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .imgBox { aspect-ratio:1/1; }
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 1rem;
      padding: 1rem;
      text-align: center;
      color: #888;
      transition: background .2s, border .2s;
      cursor: pointer;
    }
    .drop-zone.dragover { background:#fef2f2; border-color:#dc2626; color:#dc2626; }
    @media print { .no-print { display:none !important; } html, body { background:white; } }
  </style>
</head>
<body class="min-h-screen text-gray-900">
  <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">

    <header class="space-y-1">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-red-700 leading-tight">
        CALCULADORA INFINITY<br/>AUDIO
      </h1>
      <p class="text-sm text-gray-600">36 meses sin intereses · 6 meses con 7,95% TAE</p>
    </header>

    <!-- Características -->
    <section class="paper rounded-2xl overflow-hidden">
      <div class="p-4 md:p-6 border-b flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-700">Características de gamas</h2>
        <button id="btn-edit" class="text-xs px-3 py-1.5 rounded-lg bg-red-600 text-white hover:bg-red-700 no-print">
          Editar contenido
        </button>
      </div>

      <div class="p-4 md:p-6 space-y-4">
        <div id="caracteristicas" class="whitespace-pre-wrap text-sm text-gray-800"></div>
        <div id="galeria" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
      </div>
    </section>

    <!-- Financiación (cálculo fijo) -->
    <section class="paper rounded-2xl p-4 md:p-6 space-y-4">
      <h3 class="text-sm font-semibold text-gray-700">Financiación Infinity</h3>
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="bg-red-600 text-white rounded-xl p-4">
          <div class="text-xs opacity-90 mb-1">Importe total (Diamante Plus)</div>
          <div class="text-3xl font-extrabold"><span id="importe">3995,00 €</span></div>
          <div class="text-[11px] opacity-90 mt-1">sin intereses</div>
        </div>
        <div class="bg-white rounded-xl p-4 border"><div class="text-xs text-gray-600 mb-1">Cuota 36 meses</div><div id="cuota36" class="text-xl font-bold">95,12 €</div></div>
        <div class="bg-white rounded-xl p-4 border"><div class="text-xs text-gray-600 mb-1">Importe restante (6m)</div><div id="restante6" class="text-xl font-bold">570,71 €</div></div>
        <div class="bg-white rounded-xl p-4 border"><div class="text-xs text-gray-600 mb-1">Financiación 6m (7,95% TAE)</div><div id="cuota6" class="text-xl font-bold">97,26 €</div></div>
      </div>
    </section>

    <!-- Modal editor -->
    <dialog id="dlg-edit" class="rounded-2xl p-0 w-full max-w-3xl">
      <form method="dialog" class="p-0 m-0">
        <div class="p-4 md:p-6 space-y-4">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold">Editar contenido</h3>
            <button class="px-3 py-1.5 rounded-lg border text-sm">Cerrar</button>
          </div>

          <label class="block text-sm text-gray-700">
            Características de gama
            <textarea id="txt-car" class="mt-1 w-full rounded-lg border-gray-300 px-3 py-2 h-40"
              placeholder="Ej.: Bluetooth LE, 16 canales, IP68, carga rápida, reducción de ruido…"></textarea>
          </label>

          <!-- Zona de imágenes -->
          <div class="space-y-2">
            <label class="text-sm text-gray-700">Imágenes (máx. 20)</label>
            <div id="drop-zone" class="drop-zone">Arrastra aquí tus imágenes o haz clic para seleccionarlas</div>
            <input id="file-add" type="file" accept="image/*" multiple class="hidden" />
            <div id="preview" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3"></div>
          </div>

          <div class="flex justify-end gap-2">
            <button id="btn-reload" type="button" class="px-3 py-2 rounded-lg border bg-white text-sm">Recargar</button>
            <button id="btn-save" type="button" class="px-3 py-2 rounded-lg bg-red-600 text-white text-sm">Guardar</button>
          </div>

          <div id="msg" class="text-sm"></div>
        </div>
      </form>
    </dialog>

    <!-- Modal PIN -->
    <dialog id="dlg-pin" class="rounded-2xl p-0 w-full max-w-xs">
      <form method="dialog" class="p-0 m-0">
        <div class="p-4 space-y-3">
          <h3 class="text-base font-semibold">Introduce PIN</h3>
          <input id="pin" type="password" inputmode="numeric" maxlength="8"
                 class="w-full rounded-lg border-gray-300 px-3 py-2 text-center tracking-widest"
                 placeholder="••••" />
          <div class="flex justify-end gap-2">
            <button class="px-3 py-2 rounded-lg border text-sm">Cancelar</button>
            <button id="btn-pin-ok" class="px-3 py-2 rounded-lg bg-red-600 text-white text-sm">Aceptar</button>
          </div>
          <div id="pin-msg" class="text-sm text-red-600"></div>
        </div>
      </form>
    </dialog>

  </main>

  <!-- ======= SCRIPT ÚNICO (Firebase + localStorage + PIN + preview) ======= -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // 1) RELLENA TU CONFIG AQUÍ
  const firebaseConfig = {
    // apiKey: "TU_API_KEY",
    // authDomain: "TU_DOMINIO.firebaseapp.com",
    // projectId: "TU_PROJECT_ID",
    // storageBucket: "TU_BUCKET.appspot.com",
    // messagingSenderId: "......",
    // appId: "......"
  };

  // ========= Utilidades generales =========
  const $  = (sel, ctx=document) => ctx.querySelector(sel);
  const fmtMoneda=(n)=> n.toLocaleString('es-ES',{ minimumFractionDigits:2, maximumFractionDigits:2 })+' €';
  const mensualidad=(p,m,t)=>{const r=t/12;if(!r)return p/m;const pow=Math.pow(1+r,m);return p*(r*pow)/(pow-1);};
  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

  // ========= Storage local + PIN =========
  const STORAGE_KEY = "calc_infy_content_v1";
  const PIN_KEY     = "calc_infy_pin_v1";
  const LOCAL_TS_KEY = "calc_infy_updated_at";

  function hashPIN(pin){ let h=0; for(let i=0;i<pin.length;i++){ h=(h<<5)-h + pin.charCodeAt(i); h|=0; } return String(h); }
  function getPINHash(){ return localStorage.getItem(PIN_KEY) || null; }
  function setPIN(pin){ localStorage.setItem(PIN_KEY, hashPIN(pin)); }
  function verifyPIN(pin){ const s=getPINHash(); return s && s===hashPIN(pin); }

  function loadLocal(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveLocal(data, ts=Date.now()){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data||{}));
    localStorage.setItem(LOCAL_TS_KEY, String(ts));
  }
  function getLocalTS(){ return Number(localStorage.getItem(LOCAL_TS_KEY) || "0"); }

  // ========= Estado =========
  let state = { caracteristicasGama:"", imagenes:[], updated_at: 0 };
  let uploads = []; // dataURL en el editor
  let cloudReady = false;

  // ========= UI refs =========
  const elCar  = $("#caracteristicas");
  const elGal  = $("#galeria");
  const btnEdit = $("#btn-edit");

  const dlgEdit = $("#dlg-edit");
  const txtCar  = $("#txt-car");
  const drop    = $("#drop-zone");
  const fileInp = $("#file-add");
  const preview = $("#preview");
  const btnReload = $("#btn-reload");
  const btnSave   = $("#btn-save");
  const msgEdit   = $("#msg");

  const dlgPIN   = $("#dlg-pin");
  const pinInput = $("#pin");
  const btnPINOk = $("#btn-pin-ok");
  const pinMsg   = $("#pin-msg");

  // ========= Pintar =========
  function pintar(){
    elCar.textContent = state.caracteristicasGama || "";
    elGal.innerHTML = "";
    (state.imagenes||[]).forEach(u=>{
      const box=document.createElement('div');
      box.className='bg-white border rounded-xl p-3 flex items-center justify-center imgBox';
      const img=new Image(); img.src=u; img.className='object-cover h-full w-full rounded-lg';
      box.appendChild(img); elGal.appendChild(box);
    });

    const amount=3995, principal=amount/42, rest=amount-(principal*36), cuota6=mensualidad(rest,6,0.0795);
    $("#importe").textContent   = fmtMoneda(amount);
    $("#cuota36").textContent   = fmtMoneda(principal);
    $("#restante6").textContent = fmtMoneda(rest);
    $("#cuota6").textContent    = fmtMoneda(cuota6);
  }

  // ========= Preview imágenes =========
  function renderPreview(){
    preview.innerHTML="";
    uploads.forEach((u,i)=>{
      const card=document.createElement('div'); card.className='relative';
      const img=new Image(); img.src=u; img.className='rounded-xl object-cover w-full h-24';
      const del=document.createElement('button'); del.type='button'; del.textContent='❌';
      del.className='absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full px-1.5 hover:bg-red-700';
      del.onclick=()=>{ uploads.splice(i,1); renderPreview(); };
      card.appendChild(img); card.appendChild(del); preview.appendChild(card);
    });
  }
  function handleFiles(files){
    [...files].forEach(f=>{
      const r=new FileReader();
      r.onload=()=>{ uploads.push(r.result); renderPreview(); };
      r.readAsDataURL(f);
    });
  }
  drop.addEventListener('click',()=>fileInp.click());
  drop.addEventListener('dragover',e=>{e.preventDefault(); drop.classList.add('dragover');});
  drop.addEventListener('dragleave',()=>drop.classList.remove('dragover'));
  drop.addEventListener('drop',e=>{ e.preventDefault(); drop.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
  fileInp.addEventListener('change',e=>handleFiles(e.target.files));

  // ========= PIN =========
  function pedirPIN({mode}={mode:"verify"}){
    return new Promise(resolve=>{
      pinMsg.textContent=""; pinInput.value=""; dlgPIN.showModal();

      function cleanup(ok,val){ dlgPIN.close(); btnPINOk.removeEventListener('click',onOk); dlgPIN.removeEventListener('close',onCancel); resolve(ok?val:null); }
      function onOk(e){
        e.preventDefault();
        const val=(pinInput.value||"").trim();
        if(!val){ pinMsg.textContent="Introduce un PIN."; return; }
        if(mode==="set"){ setPIN(val); cleanup(true,val); }
        else { if(verifyPIN(val)) cleanup(true,val); else pinMsg.textContent="PIN incorrecto."; }
      }
      function onCancel(){ cleanup(false,null); }

      btnPINOk.addEventListener('click',onOk);
      dlgPIN.addEventListener('close',onCancel,{once:true});
    });
  }

  // ========= Firebase (pull/push) =========
  let app, db, docRef;

  async function initFirebase(){
    try{
      if (!firebaseConfig || !firebaseConfig.projectId) {
        // Config vacío: solo local
        cloudReady = false;
        return;
      }
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      docRef = doc(db, "calculadoraInfy", "contenido"); // cambia IDs si quieres varios documentos
      cloudReady = true;
    } catch(err){
      console.warn("Firebase no inicializado:", err);
      cloudReady = false;
    }
  }

  async function pullCloud(){
    if(!cloudReady) return null;
    try{
      const snap = await getDoc(docRef);
      if(!snap.exists()) return null;
      return snap.data();
    }catch(err){
      console.warn("No se pudo leer Firestore:", err);
      return null;
    }
  }

  async function pushCloud(data){
    if(!cloudReady) return false;
    try{
      await setDoc(docRef, data, { merge:true });
      return true;
    }catch(err){
      console.warn("No se pudo guardar en Firestore:", err);
      return false;
    }
  }

  // ========= Sincronización inicial (elige la fuente más reciente) =========
  async function cargarInicial(){
    // Carga local
    const local = loadLocal();
    const localTS = getLocalTS();

    // Intenta nube
    const cloud = await pullCloud();
    const cloudTS = (cloud && typeof cloud.updated_at==='number') ? cloud.updated_at : 0;

    // Decide la fuente
    if (cloud && cloudTS > localTS) {
      state = {
        caracteristicasGama: cloud.caracteristicasGama || "",
        imagenes: Array.isArray(cloud.imagenes) ? cloud.imagenes : [],
        updated_at: cloudTS
      };
      // también actualiza local con lo de la nube
      saveLocal({ caracteristicasGama: state.caracteristicasGama, imagenes: state.imagenes }, cloudTS);
    } else {
      state = {
        caracteristicasGama: local.caracteristicasGama || "",
        imagenes: Array.isArray(local.imagenes) ? local.imagenes : [],
        updated_at: localTS || 0
      };
      // si nube está lista y lo local es más nuevo, empuja
      if (cloudReady && localTS && localTS > cloudTS) {
        await pushCloud({ ...state });
      }
    }

    pintar();
  }

  // ========= Eventos de editor =========
  btnEdit.addEventListener('click',()=>{
    txtCar.value = state.caracteristicasGama || "";
    uploads = [...state.imagenes];
    renderPreview();
    msgEdit.className = "text-sm";
    msgEdit.textContent="";
    pinMsg.textContent="";
    dlgEdit.showModal();
  });

  btnReload.addEventListener('click', async ()=>{
    msgEdit.className="text-sm";
    msgEdit.textContent="Recargando…";
    await cargarInicial();
    txtCar.value = state.caracteristicasGama || "";
    uploads = [...state.imagenes];
    renderPreview();
    msgEdit.className="text-sm text-green-700";
    msgEdit.textContent="Contenido sincronizado.";
  });

  btnSave.addEventListener('click', async ()=>{
    msgEdit.className="text-sm";
    msgEdit.textContent = "Guardando…";
    const hasPIN = !!getPINHash();
    const pin = await pedirPIN({ mode: hasPIN ? "verify" : "set" });
    if(!pin){ msgEdit.textContent = hasPIN ? "Guardado cancelado." : "PIN no establecido."; return; }

    // Actualiza estado
    state.caracteristicasGama = txtCar.value || "";
    state.imagenes = uploads.slice(0,20);
    state.updated_at = Date.now();

    // Guarda local
    saveLocal({ caracteristicasGama: state.caracteristicasGama, imagenes: state.imagenes }, state.updated_at);

    // Sube a la nube si está disponible
    let cloudOk = false;
    if (cloudReady) {
      cloudOk = await pushCloud({ ...state });
    }

    pintar();
    msgEdit.className = "text-sm " + (cloudOk || !cloudReady ? "text-green-700" : "text-yellow-700");
    msgEdit.textContent = cloudOk ? "Guardado en la nube ✓" : (!cloudReady ? "Guardado local ✓ (sin nube)" : "Guardado local ✓ (nube no disponible)");
  });

  // ========= Inicio =========
  await initFirebase();
  await cargarInicial();

  </script>
</body>
</html>
